<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Refund Details - TreasureGO</title>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

  <script src="../../Public_Assets/js/headerbar.js"></script>

  <style>
    /* =========================================
       1. Global Variables & Reset (Referencing Refund_Request)
       ========================================= */
    :root {
      --primary: #4F46E5;
      --primary-hover: #4338CA;
      --primary-light: #EEF2FF;
      --text-dark: #111827;
      --text-gray: #6B7280;
      --input-bg: #F3F4F6;
      --border-radius: 16px;
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: #F0F2F5;
      /* Signature background pattern from Request page */
      background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%234f46e5" fill-opacity="0.03"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'), linear-gradient(to bottom right, #f3f4f6, #e5e7eb);
      color: var(--text-dark);
      min-height: 100vh;
      padding-bottom: 40px;
    }

    /* Container Styles (Referencing .publish-container) */
    .publish-container {
      max-width: 800px;
      margin: 40px auto;
      background: #ffffff;
      border-radius: 24px;
      padding: 50px;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255,255,255,0.6);
      animation: fadeInPage 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes fadeInPage {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .page-title {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 30px;
      color: var(--text-dark);
      text-align: center;
      letter-spacing: -1px;
      background: linear-gradient(135deg, #111827 0%, #4F46E5 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* =========================================
       2. Specific Styles for Details Components
       ========================================= */

    /* Status Banners */
    .status-banner {
      padding: 20px 25px; border-radius: 16px; margin-bottom: 30px;
      display: flex; gap: 15px; align-items: flex-start;
      animation: fadeIn 0.3s ease-out;
    }
    .status-banner i { font-size: 1.4rem; margin-top: 2px; }
    .status-content h3 { margin: 0 0 5px 0; font-size: 1.1rem; font-weight: 700; }
    .status-content p { margin: 0; font-size: 0.95rem; opacity: 0.9; line-height: 1.5; font-weight: 500; }

    /* Status Colors */
    .banner-pending { background: #FFF7ED; border: 1px solid #FED7AA; color: #9A3412; }
    .banner-pending i { color: #F97316; }

    .banner-success { background: #F0FDF4; border: 1px solid #86EFAC; color: #166534; }
    .banner-success i { color: #16A34A; }

    .banner-rejected { background: #FEF2F2; border: 1px solid #FECACA; color: #991B1B; }
    .banner-rejected i { color: #EF4444; }

    .banner-return { background: #EFF6FF; border: 1px solid #BFDBFE; color: #1E40AF; }
    .banner-return i { color: #3B82F6; }

    .banner-action { background: #EEF2FF; border: 1px solid #C7D2FE; color: #4338CA; }
    .banner-action i { color: #4F46E5; }

    .banner-dispute { background: #F5F3FF; border: 1px solid #DDD6FE; color: #5B21B6; }
    .banner-dispute i { color: #7C3AED; }

    /* Layout Grid */
    .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }

    /* Info Card (Adapted to match Request page's gray boxes) */
    .info-card {
      background: #F8FAFC;
      padding: 25px;
      border-radius: 16px;
      border: 1px solid #E2E8F0;
    }

    .label { font-size: 0.75rem; color: #6B7280; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 8px; }
    .value { font-size: 1.1rem; font-weight: 600; color: #1F2937; }
    .amount-text { color: var(--primary); font-size: 1.8rem; font-weight: 800; }

    /* Description Box */
    .desc-box {
      background: white; border: 1px solid #E5E7EB;
      padding: 15px; border-radius: 12px;
      color: #4B5563; line-height: 1.7; font-size: 0.95rem;
    }

    /* Evidence Gallery */
    .gallery-grid { display: flex; gap: 12px; margin-top: 15px; flex-wrap: wrap; }
    .evidence-img {
      width: 100px; height: 100px; border-radius: 12px;
      object-fit: cover; cursor: pointer; border: 2px solid white;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: 0.2s;
    }
    .evidence-img:hover { transform: scale(1.05); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

    /* Buttons */
    .btn-group { display: flex; justify-content: center; margin-top: 40px; }
    .btn-back {
      padding: 15px 40px; background: white; color: var(--text-gray); border: 2px solid #E5E7EB;
      border-radius: 50px; font-size: 1rem; font-weight: 600; cursor: pointer; text-decoration: none;
      display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s;
    }
    .btn-back:hover { background: #F3F4F6; color: var(--text-dark); border-color: #D1D5DB; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 768px) {
      .publish-container { padding: 30px 20px; margin: 20px; }
      .details-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<script>
  if (typeof TreasureGoHeaderbar !== 'undefined') {
    TreasureGoHeaderbar.mount({ basePath: '../../' });
  }
</script>

<div class="publish-container">

  <h1 class="page-title">Refund Details</h1>

  <div id="statusMessageContainer"></div>

  <div class="details-grid">
    <div class="info-card">
      <div class="label">Refund Amount</div>
      <div class="value amount-text" id="refundAmount">RM0.00</div>
      <div style="margin-top:20px;" class="label">Refund Type</div>
      <div class="value" id="refundType">-</div>
    </div>

    <div class="info-card">
      <div class="label">Reason Category</div>
      <div class="value" id="refundReason">-</div>
      <div style="margin-top:20px;" class="label">Request Date</div>
      <div class="value" style="font-size:1rem;" id="refundDate">-</div>
    </div>
  </div>

  <div class="info-card">
    <div class="label">Detailed Description</div>
    <div class="desc-box" id="refundDesc">
      No description provided.
    </div>

    <div style="margin-top:30px;">
      <div class="label">Evidence / Photos</div>
      <div class="gallery-grid" id="evidenceGallery">
        <span style="color:#9CA3AF; font-size:0.9rem; font-style:italic;">No photos uploaded.</span>
      </div>
    </div>
  </div>

  <div class="btn-group">
    <a href="javascript:history.back()" class="btn-back"><i class="ri-arrow-left-line"></i> Back to Orders</a>
  </div>

</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const ORDER_ID = urlParams.get('order_id');
  const API_URL = '../../Module_Transaction_Fund/api/Get_User_Orders.php';

  let currentUserId = null;

  async function loadDetails() {
    if(!ORDER_ID) return alert("No Order ID provided.");

    try {
      // 1. 获取当前用户ID
      const sessionRes = await fetch('../../Module_User_Account_Management/api/session_status.php');
      const sessionData = await sessionRes.json();
      if (!sessionData.is_logged_in) {
        window.location.href = '../../Module_User_Account_Management/pages/login.php';
        return;
      }
      currentUserId = sessionData.user.user_id;

      // 2. 调用 API
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error(`API Error: ${res.statusText}`);
      const data = await res.json();
      if(!data.success) throw new Error(data.msg || "Failed to load data.");

      const allOrders = [...(data.buying || []), ...(data.selling || [])];
      const order = allOrders.find(o => o.Orders_Order_ID == ORDER_ID);

      if(order) {
        renderPage(order);
      } else {
        document.body.innerHTML = "<div class='publish-container' style='text-align:center;'><h3>Order Not Found</h3><a href='javascript:history.back()' class='btn-back'>Go Back</a></div>";
      }

    } catch(e) {
      console.error(e);
      document.getElementById('statusMessageContainer').innerHTML = `<div class="status-banner banner-rejected"><i class="ri-error-warning-fill"></i><div class="status-content"><h3>Error</h3><p>${e.message}</p></div></div>`;
    }
  }

  function renderPage(order) {
    // 1. 填充基础信息
    const amount = order.Refund_Amount ? parseFloat(order.Refund_Amount).toFixed(2) : '0.00';
    document.getElementById('refundAmount').innerText = 'RM' + amount;

    let typeText = '-';
    if (order.Refund_Type === 'refund_only') typeText = 'Refund Only';
    else if (order.Refund_Type === 'return_refund') typeText = 'Return & Refund';
    document.getElementById('refundType').innerText = typeText;

    // Reason Map
    const reasonMap = {
      damaged: 'Item Damaged / Defective',
      wrong_item: 'Received Wrong Item',
      not_described: 'Item Not As Described',
      missing_parts: 'Missing Parts / Accessories',
      fake: 'Counterfeit / Fake Item',
      other: 'Other',
    };
    const readableReason = reasonMap[order.Refund_Reason] || order.Refund_Reason || 'Not Specified';

    document.getElementById('refundReason').innerText = readableReason;

    const dateStr = order.Refund_Updated_At || order.Refund_Created_At || new Date().toISOString();
    document.getElementById('refundDate').innerText = new Date(dateStr).toLocaleDateString();

    if(order.Refund_Description) {
      document.getElementById('refundDesc').innerText = order.Refund_Description;
    }

    // 2. Render the status banner based on refund state and user role.
    const statusDiv = document.getElementById('statusMessageContainer');
    const status = order.Refund_Status;
    const isBuyer = (order.Orders_Buyer_ID == currentUserId);

    let bannerHtml = '';

    if(status === 'pending_approval') {
      if (isBuyer) {
        bannerHtml = `
            <div class="status-banner banner-pending">
                <i class="ri-hourglass-fill"></i>
                <div class="status-content">
                    <h3>Waiting for Seller Review</h3>
                    <p>The request has been sent. The seller will review your request shortly.</p>
                </div>
            </div>`;
      } else {
        bannerHtml = `
            <div class="status-banner banner-action">
                <i class="ri-error-warning-fill"></i>
                <div class="status-content">
                    <h3>Action Required: Refund Requested</h3>
                    <p>The buyer has requested a refund. Please review the details below.</p>
                </div>
            </div>`;
      }
    }
    else if (status === 'awaiting_return') {
      bannerHtml = `
            <div class="status-banner banner-return">
                <i class="ri-truck-line"></i>
                <div class="status-content">
                    <h3>Return In Progress</h3>
                    <p>${isBuyer ? 'Please return the item and submit tracking.' : 'Waiting for buyer to return the item.'}</p>
                </div>
            </div>`;
    }
    else if (status === 'completed') {
      bannerHtml = `
            <div class="status-banner banner-success">
                <i class="ri-checkbox-circle-fill"></i>
                <div class="status-content">
                    <h3>Refund Completed</h3>
                    <p>Funds have been returned.</p>
                </div>
            </div>`;
    }
    else if (status === 'rejected') {
      bannerHtml = `
            <div class="status-banner banner-rejected">
                <i class="ri-close-circle-fill"></i>
                <div class="status-content">
                    <h3>Request Rejected</h3>
                    <p>The refund request was rejected.</p>
                </div>
            </div>`;
    }
    else if (status === 'dispute_in_progress') {
      bannerHtml = `
            <div class="status-banner banner-dispute">
                <i class="ri-customer-service-2-fill"></i>
                <div class="status-content">
                    <h3>Dispute In Progress</h3>
                    <p>Platform support team has been notified. We are reviewing the case.</p>
                </div>
            </div>`;
    }
    else {
      const displayStatus = status
              ? status.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')
              : 'Unknown';

      bannerHtml = `
            <div class="status-banner" style="background:#F3F4F6; color:#374151;">
                <i class="ri-information-line"></i>
                <div class="status-content"><h3>Status: ${displayStatus}</h3></div>
            </div>`;
    }

    statusDiv.innerHTML = bannerHtml;

    // 3. Render evidence images (if any).
    const gallery = document.getElementById('evidenceGallery');
    if(order.Refund_Images) {
      gallery.innerHTML = '';
      let images = [];
      try {
        if(order.Refund_Images.startsWith('[')) images = JSON.parse(order.Refund_Images);
        else images = order.Refund_Images.split(',');
      } catch(e) { images = [order.Refund_Images]; }

      images.forEach(src => {
        if(src && src.trim()) {
          const img = document.createElement('img');
          let cleanSrc = src.trim();
          if(!cleanSrc.startsWith('http') && !cleanSrc.startsWith('../')) {
            cleanSrc = '../../' + cleanSrc;
          }
          img.src = cleanSrc;
          img.className = 'evidence-img';
          img.onclick = () => window.open(img.src, '_blank');
          gallery.appendChild(img);
        }
      });
    }
  }

  loadDetails();
</script>

</body>
</html>