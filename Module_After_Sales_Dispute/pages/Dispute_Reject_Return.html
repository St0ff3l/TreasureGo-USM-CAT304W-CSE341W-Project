<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dispute - Rejected Return | TreasureGO</title>

  <link href="../assets/css/upload_images.css" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

  <script src="../../Public_Assets/js/status_dialog.js"></script>

  <style>
    /* 页面基础布局样式 (保持不变) */
    :root {
      --primary: #4F46E5;
      --primary-hover: #4338CA;
      --primary-light: #EEF2FF;
      --text-dark: #111827;
      --text-gray: #6B7280;
      --bg: #F0F2F5;
      --card: #ffffff;
      --border: #E5E7EB;
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.10), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg);
      background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%234f46e5" fill-opacity="0.03"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'), linear-gradient(to bottom right, #f3f4f6, #e5e7eb);
      color: var(--text-dark);
      min-height: 100vh;
      padding: 40px 0;
    }
    .container { max-width: 850px; margin: 0 auto; padding: 0 18px; }
    .card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.6);
      border-radius: 24px;
      padding: 42px;
      box-shadow: var(--shadow-lg);
      animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
    .topbar { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 18px; }
    .back-link { display: inline-flex; align-items: center; gap: 8px; text-decoration: none; color: var(--text-gray); font-weight: 700; transition: 0.2s; }
    .back-link:hover { color: var(--primary); transform: translateX(-3px); }
    .page-title {
      font-size: 2rem; font-weight: 800; letter-spacing: -1px;
      background: linear-gradient(135deg, #111827 0%, #4F46E5 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;
    }
    .subtitle { color: var(--text-gray); margin-bottom: 22px; line-height: 1.6; }
    .status-banner {
      padding: 18px 20px; border-radius: 16px; margin: 14px 0 22px;
      display: flex; gap: 12px; align-items: flex-start;
      border: 1px solid #FECACA; background: #FEF2F2; color: #991B1B;
    }
    .status-banner i { font-size: 1.4rem; margin-top: 2px; color: #EF4444; }
    .status-banner h3 { margin: 0 0 4px; font-size: 1.05rem; }
    .status-banner p { margin: 0; opacity: 0.9; line-height: 1.6; }
    .order-summary {
      background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 18px; padding: 18px;
      display: flex; align-items: center; gap: 14px; margin-bottom: 22px;
    }
    .order-main h4 { margin-bottom: 4px; font-weight: 800; font-size: 1.05rem; }
    .order-price { font-weight: 900; color: var(--primary); font-size: 1.15rem; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 20px; }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } .card { padding: 26px; } }
    .kv { background: #ffffff; border: 1px solid var(--border); border-radius: 16px; padding: 14px 16px; }
    .kv .k { font-size: 0.78rem; color: #9CA3AF; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    .kv .v { font-weight: 700; color: #111827; word-break: break-word; }
    .section-title { margin: 18px 0 10px; font-weight: 900; font-size: 1.05rem; color: #111827; }
    label { display: block; font-weight: 800; font-size: 0.85rem; margin-bottom: 10px; color: #374151; text-transform: uppercase; letter-spacing: 0.5px; }
    select, textarea, input[type="text"] { width: 100%; padding: 14px 16px; background: #F3F4F6; border: 2px solid transparent; border-radius: 14px; font-family: inherit; font-size: 0.98rem; transition: 0.2s; }
    select:focus, textarea:focus, input[type="text"]:focus { outline: none; border-color: var(--primary); background: #fff; }
    textarea { min-height: 140px; resize: vertical; line-height: 1.6; }
    .help { font-size: 0.92rem; color: var(--text-gray); line-height: 1.6; margin-top: 8px; }
    .actions { display: flex; gap: 12px; margin-top: 22px; flex-wrap: wrap; }
    .btn { border: none; border-radius: 14px; padding: 12px 18px; font-weight: 800; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
    .btn-secondary { background: #F3F4F6; color: #374151; }
    .btn-secondary:hover { background: #E5E7EB; }
    .pill { display: inline-flex; align-items: center; gap: 6px; font-size: 0.9rem; padding: 6px 10px; border-radius: 999px; background: var(--primary-light); color: var(--primary); font-weight: 800; }
    .line { height: 1px; background: #F3F4F6; margin: 18px 0; }
    .muted { color: var(--text-gray); }
  </style>
</head>

<body>
<div class="container">
  <div class="card">
    <div class="topbar">
      <a class="back-link" href="javascript:history.back()"><i class="ri-arrow-left-line"></i>Back</a>
      <span class="pill"><i class="ri-file-warning-line"></i>Dispute</span>
    </div>

    <div class="page-title">Dispute: Rejected Return</div>
    <div class="subtitle">
      Use this page to escalate a dispute when your return request has been rejected.
      Please describe the situation clearly and attach evidence.
    </div>

    <div id="statusBanner" class="status-banner" style="display:none;"></div>
    <div id="orderSummary" class="order-summary" style="display:none;"></div>
    <div class="grid" id="orderMeta" style="display:none;"></div>

    <div class="line"></div>

    <div class="section-title">Dispute Information</div>

    <div style="margin-bottom: 18px;">
      <label for="disputeReason">Reason</label>
      <select id="disputeReason">
        <option value="seller_wrongly_rejected">Seller wrongly rejected the return</option>
        <option value="item_not_as_described">Item not as described</option>
        <option value="item_damaged">Item arrived damaged</option>
        <option value="missing_parts">Missing parts/accessories</option>
        <option value="other">Other</option>
      </select>
    </div>

    <div style="margin-bottom: 18px;">
      <label for="disputeDetails">Details</label>
      <textarea id="disputeDetails" placeholder="Describe what happened (include dates, messages, photos evidence, etc.)"></textarea>
      <div class="help">Tip: include why the rejection is unreasonable and what resolution you expect.</div>
    </div>

    <div class="section-title">Evidence (Optional)</div>
    <div id="evidence-container" style="margin-bottom: 20px;"></div>
    <div id="uploadStatus" class="help" style="color: #6B7280; margin-bottom: 8px;"></div>

    <div class="actions">
      <button class="btn btn-primary" id="btnSubmit"><i class="ri-send-plane-2-line"></i>Submit Dispute</button>
      <button class="btn btn-secondary" id="btnBackToOrder"><i class="ri-file-list-3-line"></i>Back to Order</button>
    </div>

    <div class="help" style="margin-top: 14px;">
      <span class="muted">Note:</span> This is a dispute creation page. It doesn't change your order automatically unless dispute APIs are connected.
    </div>
  </div>
</div>

<script src="../assets/js/upload_images.js"></script>

<script>
  // ================= 配置区域 =================
  const API_SUBMIT_DISPUTE = '../api/dispute_buyer_submit.php';
  const API_SESSION_STATUS = '../../Module_User_Account_Management/api/session_status.php';
  const API_GET_USER_ORDERS = '../../Module_Transaction_Fund/api/Get_User_Orders.php';

  // 全局变量
  let currentOrderId = null;
  let evidenceUploader = null;

  // ================= 页面逻辑 =================

  function getQueryParam(name) { return new URL(window.location.href).searchParams.get(name); }
  function formatMoney(n) { return isNaN(Number(n)) ? 'RM 0.00' : 'RM ' + Number(n).toFixed(2); }

  async function uploadImagesFirst(files, orderId) {
    if (files.length === 0) return [];

    const statusDiv = document.getElementById('uploadStatus');
    statusDiv.innerHTML = '<span style="color:blue"><i class="ri-loader-4-line ri-spin"></i> Uploading evidence images...</span>';

    const fd = new FormData();
    fd.append('order_id', orderId);
    // 注意：这里必须和 PHP 接收的字段一致，PHP 里我们写的是 evidence[]
    Array.from(files).forEach(f => fd.append('evidence[]', f));

    const res = await fetch(API_SUBMIT_DISPUTE, { method: 'POST', body: fd });
    const data = await res.json();

    if (!data.success) throw new Error(data.message || 'Image upload failed');
    return data.files.map(f => f.url);
  }

  function setupSubmitLogic(orderId) {
    document.getElementById('btnSubmit').addEventListener('click', async () => {
      const reason = document.getElementById('disputeReason').value;
      const details = document.getElementById('disputeDetails').value.trim();
      const btn = document.getElementById('btnSubmit');

      if (details.length < 10) return alert('Please describe details (min 10 chars).');
      if (!confirm('Submit dispute now?')) return;

      btn.disabled = true;
      btn.innerHTML = 'Processing...';

      try {
        // 1. 先从组件里拿文件并上传
        const files = evidenceUploader.getFiles();
        let uploadedUrls = [];

        if (files.length > 0) {
          uploadedUrls = await uploadImagesFirst(files, orderId);
        }

        // 2. 拿到 URL 后，提交 JSON 数据
        const payload = {
          order_id: orderId,
          dispute_reason: reason,
          dispute_details: details,
          evidence_images: uploadedUrls,
          dispute_type: 'rejected_return'
        };

        const res = await fetch(API_SUBMIT_DISPUTE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (data.success) {
          alert('Dispute submitted! ID: ' + data.dispute_id);
          window.location.href = `../../Module_Transaction_Fund/pages/Order_Details.html?id=${orderId}`;
        } else {
          throw new Error(data.message);
        }

      } catch (e) {
        alert('Error: ' + e.message);
        document.getElementById('uploadStatus').innerText = '';
        btn.disabled = false;
        btn.innerHTML = '<i class="ri-send-plane-2-line"></i> Submit Dispute';
      }
    });
  }

  (async function init() {
    currentOrderId = getQueryParam('order_id') || getQueryParam('id');

    if (!currentOrderId) {
      const banner = document.getElementById('statusBanner');
      banner.style.display = 'flex';
      banner.innerHTML = `<h3>⚠️ Missing Order ID</h3><p>Please open this page from Order Details.</p>`;
      return;
    }

    const sessionRes = await fetch(API_SESSION_STATUS);
    const sData = await sessionRes.json();
    if (!sData.is_logged_in) { window.location.href = '../../Module_User_Account_Management/pages/login.php'; return; }

    try {
      const res = await fetch(API_GET_USER_ORDERS);
      const data = await res.json();
      const order = (data.buying || []).find(o => String(o.Orders_Order_ID) === String(currentOrderId));
      if (order) {
        document.getElementById('orderSummary').style.display = 'flex';
        document.getElementById('orderSummary').innerHTML = `<div style="font-weight:bold; font-size:1.1rem;">Order #${order.Orders_Order_ID} - ${formatMoney(order.Orders_Total_Amount)}</div><div style="color:#666; margin-left:10px;">${order.Product_Title || 'Product'}</div>`;
      }
    } catch(e) { console.error(e); }

    // ==========================================
    // 初始化上传组件 (现在使用外部文件里的类)
    // ==========================================
    evidenceUploader = new TreasureGoUploader('#evidence-container', {
      inputName: 'evidence[]'
    });

    setupSubmitLogic(currentOrderId);

    document.getElementById('btnBackToOrder').onclick = () => {
      window.location.href = `../../Module_Transaction_Fund/pages/Order_Details.html?id=${currentOrderId}`;
    };

  })();
</script>
</body>
</html>