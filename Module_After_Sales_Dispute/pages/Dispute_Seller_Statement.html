<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Seller Response | TreasureGO</title>

  <link href="../assets/css/upload_images.css" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

  <script src="../../Public_Assets/js/status_dialog.js"></script>

  <style>
    /* =========================================
       æ ¸å¿ƒæ ·å¼ (ç›´æ¥å¤ç”¨è‡ª Dispute_Reject_Return.html)
       ========================================= */
    :root {
      --primary: #4F46E5;
      --primary-hover: #4338CA;
      --primary-light: #EEF2FF;
      --text-dark: #111827;
      --text-gray: #6B7280;
      --bg: #F0F2F5;
      --card: #ffffff;
      --border: #E5E7EB;
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.10), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg);
      /* èƒŒæ™¯çº¹ç†ä¿æŒä¸€è‡´ */
      background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%234f46e5" fill-opacity="0.03"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'), linear-gradient(to bottom right, #f3f4f6, #e5e7eb);
      color: var(--text-dark);
      min-height: 100vh;
      padding: 40px 0;
    }
    .container { max-width: 850px; margin: 0 auto; padding: 0 18px; }
    .card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.6);
      border-radius: 24px;
      padding: 42px;
      box-shadow: var(--shadow-lg);
      animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

    .topbar { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 18px; }
    .back-link { display: inline-flex; align-items: center; gap: 8px; text-decoration: none; color: var(--text-gray); font-weight: 700; transition: 0.2s; }
    .back-link:hover { color: var(--primary); transform: translateX(-3px); }

    .pill { display: inline-flex; align-items: center; gap: 6px; font-size: 0.9rem; padding: 6px 10px; border-radius: 999px; background: var(--primary-light); color: var(--primary); font-weight: 800; }

    .page-title {
      font-size: 2rem; font-weight: 800; letter-spacing: -1px;
      background: linear-gradient(135deg, #111827 0%, #4F46E5 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;
    }
    .subtitle { color: var(--text-gray); margin-bottom: 22px; line-height: 1.6; }

    /* Order Summary æ ·å¼ */
    .order-summary {
      background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 18px; padding: 18px;
      display: flex; align-items: center; gap: 14px; margin-bottom: 22px;
    }
    .order-summary i { font-size: 1.5rem; color: var(--primary); }

    .section-title { margin: 18px 0 10px; font-weight: 900; font-size: 1.05rem; color: #111827; }

    label { display: block; font-weight: 800; font-size: 0.85rem; margin-bottom: 10px; color: #374151; text-transform: uppercase; letter-spacing: 0.5px; }

    textarea, input[type="text"] { width: 100%; padding: 14px 16px; background: #F3F4F6; border: 2px solid transparent; border-radius: 14px; font-family: inherit; font-size: 0.98rem; transition: 0.2s; }
    textarea:focus { outline: none; border-color: var(--primary); background: #fff; }
    textarea { min-height: 160px; resize: vertical; line-height: 1.6; }

    .help { font-size: 0.92rem; color: var(--text-gray); line-height: 1.6; margin-top: 8px; }
    .char-count { text-align: right; font-size: 0.85rem; color: var(--text-gray); margin-top: 6px; }

    .actions { display: flex; gap: 12px; margin-top: 26px; flex-wrap: wrap; }
    .btn { border: none; border-radius: 14px; padding: 12px 24px; font-weight: 800; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 1rem; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
    .btn-secondary { background: #F3F4F6; color: #374151; }
    .btn-secondary:hover { background: #E5E7EB; }
    .btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

    .line { height: 1px; background: #F3F4F6; margin: 22px 0; }
    .muted { color: var(--text-gray); }

    /* é”™è¯¯æç¤ºæ¡† */
    .status-msg { margin-top: 15px; padding: 12px; border-radius: 12px; display: none; font-weight: 600; font-size: 0.95rem; }
    .status-err { background: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; }
    .status-ok { background: #ECFDF5; color: #059669; border: 1px solid #A7F3D0; }
  </style>
</head>

<body>
<div class="container">
  <div class="card">
    <div class="topbar">
      <a class="back-link" href="javascript:history.back()"><i class="ri-arrow-left-line"></i>Back</a>
      <span class="pill"><i class="ri-store-2-line"></i>Seller Portal</span>
    </div>

    <div class="page-title">Respond to Dispute</div>
    <div class="subtitle">
      Please provide your explanation and supporting evidence regarding this dispute.
      This information will be reviewed by the platform support team.
    </div>

    <div id="orderSummary" class="order-summary" style="display:none;"></div>

    <div class="line"></div>

    <div class="section-title">Your Statement</div>

    <div style="margin-bottom: 22px;">
      <label for="statement">Explanation</label>
      <textarea id="statement" placeholder="Explain your side of the story (timeline, product condition, shipping proof, etc.). Minimum 20 characters."></textarea>
      <div class="char-count" id="charHint">0 characters</div>
    </div>

    <div class="section-title">Evidence (Optional)</div>
    <div id="evidence-container" style="margin-bottom: 12px;"></div>
    <div id="uploadStatus" class="help" style="margin-bottom: 8px;"></div>
    <div class="help">
      <span class="muted"><i class="ri-information-line"></i> Note:</span>
      Supported formats: JPG, PNG, WebP. Max 6 images.
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="btnSubmit">
        <i class="ri-send-plane-fill"></i> Submit Response
      </button>
      <button class="btn btn-secondary" id="btnBackToOrder">
        Cancel
      </button>
    </div>

    <div id="msgBox" class="status-msg"></div>

  </div>
</div>

<script src="../assets/js/upload_images.js"></script>

<script>
  (function () {
    'use strict';

    // ================= é…ç½®åŒºåŸŸ =================
    // æ³¨æ„ï¼šè¿™é‡Œæ²¿ç”¨ Seller ç«¯çš„ APIï¼Œä½†é€»è¾‘ä¸Šæ¨¡æ‹Ÿ Buyer ç«¯çš„â€œå…ˆä¸Šä¼ åæäº¤â€
    const API_SELLER_DISPUTE_SUBMIT = '../api/dispute_seller_submit.php';
    const API_GET_ORDER_DETAILS = '../../Module_Transaction_Fund/api/Get_User_Orders.php'; // å‡è®¾ç”¨äºè·å–è®¢å•è¯¦æƒ…

    // å…¨å±€å˜é‡
    let currentOrderId = null;
    let evidenceUploader = null;
    let uploadedEvidenceUrls = []; // å­˜å‚¨å·²å­˜åœ¨çš„æˆ–æ–°ä¸Šä¼ çš„å›¾ç‰‡é“¾æ¥

    // å·¥å…·å‡½æ•°
    function getQueryParam(name) { return new URL(window.location.href).searchParams.get(name); }
    function setMsg(text, type) {
      const el = document.getElementById('msgBox');
      el.style.display = 'block';
      el.className = `status-msg ${type === 'err' ? 'status-err' : 'status-ok'}`;
      el.innerHTML = text;
    }

    // ================= æ ¸å¿ƒé€»è¾‘ï¼šä¸Šä¼ å›¾ç‰‡ =================
    // ç±»ä¼¼äº Buyer ç«¯çš„ uploadImagesFirstï¼Œä½†æŒ‡å‘ Seller API
    async function uploadImagesFirst(files, orderId) {
      if (files.length === 0) return [];

      const statusDiv = document.getElementById('uploadStatus');
      statusDiv.innerHTML = '<span style="color:var(--primary)"><i class="ri-loader-4-line ri-spin"></i> Uploading evidence images...</span>';

      const fd = new FormData();
      fd.append('order_id', orderId);
      // æ³¨æ„ï¼šå­—æ®µåéœ€ä¸ PHP æ¥æ”¶ç«¯ä¸€è‡´ (evidence[])
      Array.from(files).forEach(f => fd.append('evidence[]', f));

      // è°ƒç”¨ Seller API è¿›è¡Œä¸Šä¼ 
      // å‡è®¾è¯¥ API æ£€æµ‹åˆ° POST åŒ…å«æ–‡ä»¶ä¸”æ²¡æœ‰ JSON body æ—¶ä¼šå¤„ç†ä¸Šä¼ 
      const res = await fetch(API_SELLER_DISPUTE_SUBMIT, { method: 'POST', body: fd });
      const data = await res.json();

      if (!data.success) throw new Error(data.message || 'Image upload failed');

      statusDiv.innerHTML = '<span style="color:#059669"><i class="ri-check-line"></i> Images uploaded successfully.</span>';
      return data.files.map(f => f.url);
    }

    // ================= æ ¸å¿ƒé€»è¾‘ï¼šæäº¤è¡¨å• =================
    async function handleSubmit() {
      const statement = document.getElementById('statement').value.trim();

      // 1. ğŸ”¥ æ–°å¢ï¼šä» URL è·å–ä¸Šä¸€æ­¥é€‰å¥½çš„åŸå› å’Œæ”¶è´§çŠ¶æ€
      const reasonCode = getQueryParam('reason');
      const receivedStatus = getQueryParam('received');

      if (!currentOrderId) return setMsg('Missing Order ID.', 'err');

      // æ£€æŸ¥ï¼šå¦‚æœ URL é‡Œæ²¡æœ‰ reasonï¼Œè¯´æ˜æµç¨‹å¯èƒ½æœ‰é—®é¢˜ï¼Œç»™ä¸ªé»˜è®¤å€¼é˜²æ­¢æŠ¥é”™
      const finalReason = reasonCode || 'Seller_Refused_Return';

      if (statement.length < 20) return setMsg('Please provide a detailed explanation (min 20 chars).', 'err');

      if (!confirm('Are you sure you want to submit this response?')) return;

      const btn = document.getElementById('btnSubmit');
      btn.disabled = true;
      btn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> Processing...';
      setMsg('', '');

      try {
        const files = evidenceUploader.getFiles();
        let newUploadedUrls = [];

        if (files.length > 0) {
          newUploadedUrls = await uploadImagesFirst(files, currentOrderId);
        }

        const finalEvidenceList = [...uploadedEvidenceUrls, ...newUploadedUrls];

        // 2. ğŸ”¥ ä¿®æ”¹ï¼šæ„å»º Payloadï¼ŒæŠŠåŸå› ä¼ ç»™åç«¯
        const payload = {
          order_id: currentOrderId,
          seller_response: statement,
          evidence_images: finalEvidenceList,
          // æ–°å¢å­—æ®µ
          reason_code: finalReason,       // ä¼ ç»™åç«¯å¡«å…¥ Dispute_Details
          received_status: receivedStatus // ä¼ ç»™åç«¯è®°å½•æ˜¯å¦æ”¶åˆ°è´§
        };

        const res = await fetch(API_SELLER_DISPUTE_SUBMIT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.success) {
          setMsg('Response submitted successfully! Redirecting...', 'ok');
          setTimeout(() => {
            window.location.href = `../../Module_Transaction_Fund/pages/Order_Details.html?id=${currentOrderId}`;
          }, 1500);
        } else {
          throw new Error(data.message); // å¦‚æœåç«¯è¿˜æœ‰é—®é¢˜ï¼Œè¿™é‡Œä¼šæ•è·
        }

      } catch (e) {
        console.error(e);
        setMsg('Error: ' + e.message, 'err');
        btn.disabled = false;
        btn.innerHTML = '<i class="ri-send-plane-fill"></i> Submit Response';
        document.getElementById('uploadStatus').innerHTML = '';
      }
    }

    // ================= åˆå§‹åŒ– =================
    async function init() {
      currentOrderId = getQueryParam('order_id') || getQueryParam('id');

      if (!currentOrderId) {
        setMsg('Critical Error: No Order ID provided in URL.', 'err');
        document.getElementById('btnSubmit').disabled = true;
        return;
      }

      // 1. è®¾ç½®è¿”å›æŒ‰é’®
      document.getElementById('btnBackToOrder').onclick = () => {
        window.location.href = `../../Module_Transaction_Fund/pages/Order_Details.html?id=${currentOrderId}`;
      };

      // 2. åˆå§‹åŒ–ä¸Šä¼ ç»„ä»¶
      evidenceUploader = new TreasureGoUploader('#evidence-container', {
        inputName: 'evidence[]',
        maxFiles: 6
      });

      // 3. åŠ è½½å·²æœ‰æ•°æ® (å¦‚æœæœ‰ï¼Œä¾‹å¦‚æŸ¥çœ‹ä¹‹å‰çš„è¯æ®)
      // è¿™é‡Œå¯ä»¥å¤ç”¨ "list_evidence" é€»è¾‘ï¼Œå¦‚æœå–å®¶ä¹‹å‰ä¸Šä¼ è¿‡å›¾ç‰‡æƒ³å›æ˜¾
      try {
        const res = await fetch(`${API_SELLER_DISPUTE_SUBMIT}?action=list_evidence&order_id=${currentOrderId}`);
        const data = await res.json();
        if (data.success && data.files && data.files.length > 0) {
          uploadedEvidenceUrls = data.files.map(f => f.url);
          // æ³¨æ„ï¼šTreasureGoUploader ä¸»è¦ç”¨äºä¸Šä¼ æ–°å›¾ã€‚
          // å¦‚æœéœ€è¦æ˜¾ç¤ºæ—§å›¾ï¼Œå¯ä»¥åœ¨ #evidence-container ä¸Šæ–¹æˆ–ä¸‹æ–¹æ‰‹åŠ¨æ¸²æŸ“ä¸€ä¸ª gridï¼Œ
          // æˆ–è€…ä¿®æ”¹ TreasureGoUploader æ”¯æŒ setInitialFiles (å¦‚æœæ”¯æŒçš„è¯)ã€‚
          // ä¸ºä¿æŒç®€å•ï¼Œè¿™é‡Œæš‚ä¸æ˜¾ç¤ºæ—§å›¾é¢„è§ˆï¼Œä»…åœ¨é€»è¾‘å±‚ä¿ç•™æ•°æ®ã€‚
        }

        // å°è¯•åŠ è½½è®¢å•æ‘˜è¦ (å¯é€‰ï¼Œå¢åŠ ç”¨æˆ·ä½“éªŒ)
        // è¿™é‡Œçš„ API è°ƒç”¨é€»è¾‘å–å†³äºæ‚¨çš„ç³»ç»Ÿæ˜¯å¦å…è®¸å–å®¶è¯»å–æ­¤ç«¯ç‚¹
        document.getElementById('orderSummary').style.display = 'flex';
        document.getElementById('orderSummary').innerHTML = `
          <i class="ri-file-list-3-line"></i>
          <div>
            <div style="font-weight:800; color:#111827;">Order #${currentOrderId}</div>
            <div style="font-size:0.9rem; color:#6B7280;">Dispute Resolution</div>
          </div>
        `;
      } catch (e) {
        console.log("Details load warning:", e);
      }

      // 4. ç»‘å®šæäº¤äº‹ä»¶
      document.getElementById('btnSubmit').addEventListener('click', handleSubmit);

      // 5. å­—æ•°ç›‘å¬
      document.getElementById('statement').addEventListener('input', function() {
        document.getElementById('charHint').innerText = this.value.length + ' characters';
      });
    }

    init();

  })();
</script>
</body>
</html>