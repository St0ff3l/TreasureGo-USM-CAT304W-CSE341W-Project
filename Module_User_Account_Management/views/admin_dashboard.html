<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TreasureGo</title>
    <script src="../../Public_Assets/js/admin_guard.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* --- 1. Ê†∏ÂøÉÂèòÈáè --- */
        :root {
            --bg-color: #F3F6F9;
            --primary: #4F46E5;
            --primary-hover: #4338CA;
            --text-dark: #1F2937;
            --text-gray: #6B7280;
            --card-radius: 20px;
            --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
            --input-bg: #F9FAFB;
            --border-color: #E5E7EB;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif; /* headerbar.js ‰ºöËá™Âä®Âä†ËΩΩÂ≠ó‰ΩìÔºåËøôÈáå‰øùÁïô‰Ωú‰∏∫ÂêéÂ§á */
            background-color: var(--bg-color);
            color: var(--text-dark);
            min-height: 100vh;
            background-image:
                    radial-gradient(circle at 10% 20%, rgba(79, 70, 229, 0.05) 0%, transparent 40%),
                    radial-gradient(circle at 90% 80%, rgba(245, 158, 11, 0.05) 0%, transparent 40%);
        }

        /* --- 2. Â∏ÉÂ±ÄÁ≥ªÁªü --- */
        .layout-container {
            max-width: 1200px;
            /* Ê†∏ÂøÉ‰øÆÊîπÔºö‰∏ä‰∏ãËæπË∑ù 30pxÔºåÁ°Æ‰øù‰∏é Headerbar ÁöÑË∑ùÁ¶ª */
            margin: 30px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 240px 1fr 240px;
            gap: 25px;
            align-items: start;
        }

        /* --- Â∑¶‰æß Sidebar --- */
        .sidebar-card {
            background: white; border-radius: var(--card-radius);
            padding: 20px; box-shadow: var(--card-shadow);
            position: sticky;
            /* Ê†∏ÂøÉ‰øÆÊîπÔºöË∞ÉÊï¥Âê∏È°∂‰ΩçÁΩÆÔºåHeaderbarÈ´òÂ∫¶Á∫¶80px + 30pxÈó¥Ë∑ù = 110px */
            top: 110px;
        }
        .menu-title { font-size: 0.85rem; color: var(--text-gray); font-weight: 700; margin-bottom: 10px; margin-top: 20px; text-transform: uppercase; letter-spacing: 0.5px; }
        .menu-title:first-child { margin-top: 0; }

        .menu-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 15px; margin-bottom: 5px;
            color: var(--text-dark); text-decoration: none;
            border-radius: 12px; transition: 0.2s; font-weight: 500; font-size: 0.95rem;
            cursor: pointer; border: none; background: transparent; width: 100%; text-align: left;
            font-family: inherit;
        }
        .menu-item:hover { background: #EEF2FF; color: var(--primary); }
        .menu-item i { font-size: 1.2rem; }
        .menu-item.active-view { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }

        /* --- ‰∏≠Èó¥ÂÜÖÂÆπÂå∫ --- */
        .main-content { display: flex; flex-direction: column; gap: 25px; }

        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ‰ª™Ë°®ÊùøÊ¶ÇËßàÂç°Áâá --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: white;
            border-radius: var(--card-radius);
            padding: 25px;
            box-shadow: var(--card-shadow);
            text-align: center;
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .stat-value { font-size: 2rem; font-weight: 800; color: var(--primary); margin-bottom: 5px; }
        .stat-label { font-size: 0.9rem; color: var(--text-gray); }

        /* --- ËÆæÁΩÆÂç°Áâá --- */
        .settings-card { background: white; border-radius: var(--card-radius); padding: 30px; box-shadow: var(--card-shadow); }
        .settings-header { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #F3F4F6; }
        .settings-header h2 { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }

        /* --- Ë°®Ê†ºÊ†∑Âºè --- */
        .table-container { background: white; border-radius: var(--card-radius); padding: 25px; box-shadow: var(--card-shadow); overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { text-align: left; padding: 15px; background: #F3F4F6; color: #4B5563; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #E5E7EB; }
        th:first-child { border-top-left-radius: 10px; }
        th:last-child { border-top-right-radius: 10px; }
        td { padding: 15px; border-bottom: 1px solid #F3F4F6; font-size: 0.95rem; color: #374151; }
        tr:hover td { background-color: #FAFAFA; }
        tr:last-child td { border-bottom: none; }

        /* --- BadgeÊ†∑Âºè --- */
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .badge-active { background: #ECFDF5; color: #059669; }
        .badge-pending { background: #FEF3C7; color: #D97706; }
        .badge-banned { background: #FEE2E2; color: #DC2626; }
        .badge-admin { background: #EEF2FF; color: #4F46E5; }
        .badge-user { background: #F3F4F6; color: #6B7280; }

        /* --- ÊåâÈíÆÊ†∑Âºè --- */
        .btn-outline { border: 1px solid #E5E7EB; background: white; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .btn-outline:hover { background: #F3F4F6; }
        .btn-danger { color: #EF4444; border-color: #FEE2E2; background: #FEF2F2; }
        .btn-danger:hover { background: #FEE2E2; }

        .form-input { width: 100%; padding: 12px 15px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--input-bg); font-family: inherit; font-size: 0.95rem; outline: none; transition: 0.2s; }
        .form-input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-box .form-input { flex: 1; }

        /* --- Âè≥‰æßÊìç‰ΩúÊ†è --- */
        .action-card {
            background: white; border-radius: var(--card-radius); padding: 20px; box-shadow: var(--card-shadow);
            display: flex; flex-direction: column; gap: 10px;
            /* ÂêåÊ†∑ÈúÄË¶ÅÂú®Âè≥‰æßËæπÊ†èËÆæÁΩÆ sticky top */
            position: sticky;
            top: 110px;
        }
        .action-btn { display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 12px; text-decoration: none; color: var(--text-dark); font-weight: 500; transition: 0.2s; font-size: 0.9rem; }
        .action-btn:hover { background: #F3F4F6; color: var(--primary); }
        .btn-primary-action { background: var(--text-dark); color: white; justify-content: center; font-weight: 600; margin-bottom: 10px; }
        .btn-primary-action:hover { background: black; color: white; transform: translateY(-2px); }

        .settings-card canvas { max-width: 100%; height: auto; }

        /* --- ÂìçÂ∫îÂºèË∞ÉÊï¥ --- */
        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            div[style*="grid-template-columns: 2fr 1fr"] { grid-template-columns: 1fr !important; }
            .layout-container { grid-template-columns: 200px 1fr; }
            .action-card { display: none; }
        }
        @media (max-width: 900px) {
            .layout-container { grid-template-columns: 1fr; }
            .sidebar-card { display: none; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: 1fr; }
            .search-box { flex-direction: column; }
            .search-box .form-input { width: 100%; }
        }
    </style>
</head>
<body>

<div class="layout-container">

    <aside class="sidebar-card">
        <div class="menu-title">Admin Dashboard</div>

        <button class="menu-item active-view" onclick="switchView('overview', this)">
            <i class="ri-dashboard-line"></i> Overview
        </button>

        <button class="menu-item" onclick="switchView('users', this)">
            <i class="ri-user-line"></i> User Management
        </button>

        <div style="border-top: 1px solid #F3F4F6; margin: 15px 0;"></div>

        <a href="profile.php" class="menu-item">
            <i class="ri-user-settings-line"></i> My Profile
        </a>

        <a href="#" class="menu-item" onclick="handleLogout()" style="color: #EF4444;">
            <i class="ri-logout-box-r-line"></i> Log Out
        </a>
    </aside>

    <main class="main-content">

        <div id="view-overview" class="view-section active">
            <div class="settings-card" style="margin-bottom: 25px; cursor: pointer; transition: all 0.3s;" onclick="window.location.href='../../Module_Transaction_Fund/pages/Admin_Deposit.html'" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 15px 40px rgba(79,70,229,0.15)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                <div class="settings-header" style="border-bottom: none; margin-bottom: 15px;">
                    <h2><i class="ri-money-dollar-circle-line" style="color: #F59E0B;"></i> Deposit Requests Dashboard</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%); border-radius: 16px;">
                        <div style="font-size: 1.8rem; margin-bottom: 5px;">üìã</div>
                        <div style="font-size: 1.5rem; font-weight: 800; color: #4F46E5;" id="deposit-total">-</div>
                        <div style="font-size: 0.8rem; color: #6B7280;">Total</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-radius: 16px;">
                        <div style="font-size: 1.8rem; margin-bottom: 5px;">‚è≥</div>
                        <div style="font-size: 1.5rem; font-weight: 800; color: #D97706;" id="deposit-pending">-</div>
                        <div style="font-size: 0.8rem; color: #6B7280;">Pending</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%); border-radius: 16px;">
                        <div style="font-size: 1.8rem; margin-bottom: 5px;">‚úÖ</div>
                        <div style="font-size: 1.5rem; font-weight: 800; color: #059669;" id="deposit-processed">-</div>
                        <div style="font-size: 0.8rem; color: #6B7280;">Processed</div>
                    </div>
                </div>
                <div style="margin-top: 12px; text-align: center; color: #6B7280; font-size: 0.85rem;">
                    <i class="ri-arrow-right-circle-line"></i> Click to manage deposit requests
                </div>
            </div>

            <div class="settings-card" style="margin-bottom: 25px; cursor: pointer; transition: all 0.3s;" onclick="window.location.href='../../Module_Transaction_Fund/pages/Admin_Withdrawal.html'" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 15px 40px rgba(79,70,229,0.15)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                <div class="settings-header" style="border-bottom: none; margin-bottom: 15px;">
                    <h2><i class="ri-bank-card-line" style="color: #EF4444;"></i> Withdrawal Requests Dashboard</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%); border-radius: 16px;">
                        <div style="font-size: 1.8rem; margin-bottom: 5px;">üìã</div>
                        <div style="font-size: 1.5rem; font-weight: 800; color: #4F46E5;" id="withdrawal-total">-</div>
                        <div style="font-size: 0.8rem; color: #6B7280;">Total</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-radius: 16px;">
                        <div style="font-size: 1.8rem; margin-bottom: 5px;">‚è≥</div>
                        <div style="font-size: 1.5rem; font-weight: 800; color: #D97706;" id="withdrawal-pending">-</div>
                        <div style="font-size: 0.8rem; color: #6B7280;">Pending</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%); border-radius: 16px;">
                        <div style="font-size: 1.8rem; margin-bottom: 5px;">‚úÖ</div>
                        <div style="font-size: 1.5rem; font-weight: 800; color: #059669;" id="withdrawal-processed">-</div>
                        <div style="font-size: 0.8rem; color: #6B7280;">Processed</div>
                    </div>
                </div>
                <div style="margin-top: 12px; text-align: center; color: #6B7280; font-size: 0.85rem;">
                    <i class="ri-arrow-right-circle-line"></i> Click to manage withdrawal requests
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="stat-total-users">-</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="stat-active-users">-</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-value" id="stat-pending-users">-</div>
                    <div class="stat-label">Pending Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üö´</div>
                    <div class="stat-value" id="stat-banned-users">-</div>
                    <div class="stat-label">Banned Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìß</div>
                    <div class="stat-value" id="stat-verified-rate">-</div>
                    <div class="stat-label">Verification Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-value" id="stat-new-users-7days">-</div>
                    <div class="stat-label">New Users (7d)</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px;">
                <div class="settings-card">
                    <div class="settings-header">
                        <h2><i class="ri-line-chart-line"></i> User Registration Trend (Last 30 Days)</h2>
                    </div>
                    <canvas id="registrationChart" style="max-height: 300px;"></canvas>
                </div>

                <div class="settings-card">
                    <div class="settings-header">
                        <h2><i class="ri-pie-chart-line"></i> User Status Distribution</h2>
                    </div>
                    <canvas id="statusChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <div id="login-chart-container" class="settings-card" style="display: none;">
                <div class="settings-header">
                    <h2><i class="ri-user-heart-line"></i> Login Activity (Last 7 Days)</h2>
                </div>
                <canvas id="loginChart" style="max-height: 250px;"></canvas>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div class="settings-card">
                    <div class="settings-header">
                        <h2><i class="ri-calendar-line"></i> Today</h2>
                    </div>
                    <div style="font-size: 2rem; font-weight: 800; color: var(--primary); margin: 15px 0;" id="stat-today">-</div>
                    <div style="color: var(--text-gray);">New Registrations</div>
                </div>

                <div class="settings-card">
                    <div class="settings-header">
                        <h2><i class="ri-calendar-check-line"></i> This Week</h2>
                    </div>
                    <div style="font-size: 2rem; font-weight: 800; color: var(--primary); margin: 15px 0;" id="stat-week">-</div>
                    <div style="color: var(--text-gray);">New Registrations</div>
                </div>

                <div class="settings-card">
                    <div class="settings-header">
                        <h2><i class="ri-mail-check-line"></i> Email Verification</h2>
                    </div>
                    <div style="font-size: 2rem; font-weight: 800; color: var(--primary); margin: 15px 0;" id="stat-verified">-</div>
                    <div style="color: var(--text-gray);">Verified Users</div>
                </div>

                <div class="settings-card">
                    <div class="settings-header">
                        <h2><i class="ri-shield-user-line"></i> Administrators</h2>
                    </div>
                    <div style="font-size: 2rem; font-weight: 800; color: var(--primary); margin: 15px 0;" id="stat-admins">-</div>
                    <div style="color: var(--text-gray);">Admin Accounts</div>
                </div>
            </div>
        </div>

        <div id="view-users" class="view-section">
            <div class="settings-card">
                <div class="settings-header">
                    <h2><i class="ri-user-line"></i> User Management</h2>
                </div>

                <div class="search-box">
                    <input type="text" id="user-search" class="form-input" placeholder="Search by username or email...">
                    <select id="status-filter" class="form-input" style="width: 200px;">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="pending">Pending</option>
                        <option value="banned">Banned</option>
                    </select>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="users-table-body">
                        <tr><td colspan="7" style="text-align:center; padding:40px; color:#9CA3AF;">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <aside class="action-card">
        <a href="../../Module_Product_Ecosystem/pages/Publish_Page.html" class="action-btn btn-primary-action">
            <i class="ri-add-circle-line"></i> Publish Item
        </a>

        <a href="../../Module_Transaction_Fund/pages/Admin_Deposit.html" class="action-btn">
            <i class="ri-money-dollar-circle-line"></i> Fund Requests
        </a>

        <a href="../../Module_Transaction_Fund/pages/Admin_Withdrawal.html" class="action-btn">
            <i class="ri-bank-card-line"></i> Withdrawal Requests
        </a>

        <a href="#" class="action-btn" onclick="alert('This feature is managed by other team members')">
            <i class="ri-file-warning-line"></i> Reports
        </a>

        <a href="#" class="action-btn" onclick="alert('This feature is managed by other team members')">
            <i class="ri-shopping-bag-line"></i> Orders Management
        </a>

        <a href="#" class="action-btn" onclick="alert('This feature is managed by other team members')">
            <i class="ri-file-list-3-line"></i> Product Review
        </a>

        <a href="../../Module_Platform_Governance_AI_Services/pages/admin_kb.html" class="action-btn">
            <i class="ri-book-open-line"></i> Knowledge Base Manager
        </a>
    </aside>

</div>

<script src="../../Public_Assets/js/headerbar.js"></script>
<script>
    // 2. ÊåÇËΩΩ Headerbar
    // ÂÅáËÆæÊ≠§Êñá‰ª∂Âú® Module_User_Account_Management/views/ ÁõÆÂΩï‰∏ãÔºå
    // ÈúÄË¶ÅÂõûÈÄÄ‰∏§Â±Ç (../../) ÊâçËÉΩÊâæÂà∞ Public_Assets ÂíåÂÖ∂‰ªñÊ®°Âùó
    document.addEventListener("DOMContentLoaded", () => {
        TreasureGoHeaderbar.mount({ basePath: '../../' });
    });
</script>

<script>
    let registrationChart = null;
    let statusChart = null;
    let loginChart = null;
    let allUsers = [];

    document.addEventListener('DOMContentLoaded', async () => {
        await loadAdminData();
        await loadUsers();
        await loadDepositStats();
        await loadWithdrawalStats();

        // ÊêúÁ¥¢ÂíåÁ≠õÈÄâ‰∫ã‰ª∂
        document.getElementById('user-search').addEventListener('input', filterUsers);
        document.getElementById('status-filter').addEventListener('change', filterUsers);
    });

    async function loadAdminData() {
        try {
            const res = await fetch('../api/admin_get_stats.php');
            const json = await res.json();
            if (json.success) {
                const data = json.data;

                // Êõ¥Êñ∞ÁªüËÆ°Âç°Áâá
                document.getElementById('stat-total-users').textContent = data.total_users || 0;
                document.getElementById('stat-active-users').textContent = data.active_users || 0;
                document.getElementById('stat-pending-users').textContent = data.pending_users || 0;
                document.getElementById('stat-banned-users').textContent = data.banned_users || 0;
                document.getElementById('stat-verified-rate').textContent = (data.verification_rate || 0) + '%';
                document.getElementById('stat-new-users-7days').textContent = data.new_users_7days || 0;
                document.getElementById('stat-today').textContent = data.today_registrations || 0;
                document.getElementById('stat-week').textContent = data.this_week_registrations || 0;
                document.getElementById('stat-verified').textContent = data.verified_users || 0;
                document.getElementById('stat-admins').textContent = data.admin_count || 0;

                // ÁªòÂà∂Ê≥®ÂÜåË∂ãÂäøÂõæ
                if (data.daily_registrations && data.daily_registrations.length > 0) {
                    drawRegistrationChart(data.daily_registrations);
                }

                // ÁªòÂà∂Áä∂ÊÄÅÂàÜÂ∏ÉÈ•ºÂõæ
                if (data.status_distribution && data.status_distribution.length > 0) {
                    drawStatusChart(data.status_distribution);
                }

                // ÁªòÂà∂ÁôªÂΩïÊµÅÈáèÂõæÔºàÂ¶ÇÊûúÊï∞ÊçÆÂèØÁî®Ôºâ
                if (data.daily_logins && data.daily_logins.length > 0 && data.logins_7days > 0) {
                    document.getElementById('login-chart-container').style.display = 'block';
                    drawLoginChart(data.daily_logins);
                }
            }
        } catch (err) {
            console.error("Failed to load stats:", err);
        }
    }

    function drawRegistrationChart(data) {
        const ctx = document.getElementById('registrationChart');
        if (!ctx) return;

        if (registrationChart) { registrationChart.destroy(); }

        const labels = data.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        const counts = data.map(item => item.count);

        registrationChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'New Registrations',
                    data: counts,
                    borderColor: '#4F46E5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#4F46E5',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { backgroundColor: 'rgba(0, 0, 0, 0.8)', padding: 12, titleFont: { size: 14, weight: 'bold' }, bodyFont: { size: 13 }, displayColors: false }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function drawStatusChart(data) {
        const ctx = document.getElementById('statusChart');
        if (!ctx) return;

        if (statusChart) { statusChart.destroy(); }

        const labels = data.map(item => {
            const status = item.User_Status;
            return status.charAt(0).toUpperCase() + status.slice(1);
        });
        const counts = data.map(item => parseInt(item.count));
        const colors = { 'active': '#10B981', 'pending': '#F59E0B', 'banned': '#EF4444' };
        const backgroundColors = data.map(item => colors[item.User_Status] || '#6B7280');

        statusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{ data: counts, backgroundColor: backgroundColors, borderWidth: 0, hoverOffset: 4 }]
            },
            options: {
                responsive: true, maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 15, font: { size: 12, weight: '600' }, usePointStyle: true } },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)', padding: 12,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = counts.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function drawLoginChart(data) {
        const ctx = document.getElementById('loginChart');
        if (!ctx) return;

        if (loginChart) { loginChart.destroy(); }

        const labels = data.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' });
        });
        const counts = data.map(item => item.count);

        loginChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Daily Logins', data: counts, backgroundColor: 'rgba(79, 70, 229, 0.6)', borderColor: '#4F46E5', borderWidth: 2, borderRadius: 8 }]
            },
            options: {
                responsive: true, maintainAspectRatio: true,
                plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(0, 0, 0, 0.8)', padding: 12 } },
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: 'rgba(0, 0, 0, 0.05)' } }, x: { grid: { display: false } } }
            }
        });
    }

    async function loadUsers() {
        try {
            const res = await fetch('../api/admin_get_users.php');
            const json = await res.json();
            if (json.success) {
                allUsers = json.data;
                renderUsers(allUsers);
            } else {
                document.getElementById('users-table-body').innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#EF4444;">Failed to load users</td></tr>';
            }
        } catch (err) {
            console.error("Failed to load users:", err);
            document.getElementById('users-table-body').innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#EF4444;">Connection error</td></tr>';
        }
    }

    function renderUsers(users) {
        const tbody = document.getElementById('users-table-body');
        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#9CA3AF;">No users found</td></tr>';
            return;
        }

        tbody.innerHTML = users.map(user => {
            const statusClass = user.User_Status === 'active' ? 'badge-active' : user.User_Status === 'pending' ? 'badge-pending' : 'badge-banned';
            const roleClass = user.User_Role === 'admin' ? 'badge-admin' : 'badge-user';
            const createdDate = new Date(user.User_Created_At).toLocaleDateString();

            return `
        <tr>
          <td>#${user.User_ID}</td>
          <td><strong>${escapeHtml(user.User_Username)}</strong></td>
          <td>${escapeHtml(user.User_Email)}</td>
          <td><span class="badge ${roleClass}">${user.User_Role}</span></td>
          <td><span class="badge ${statusClass}">${user.User_Status}</span></td>
          <td>${createdDate}</td>
          <td>
            <button class="btn-outline" onclick="editUserStatus(${user.User_ID}, '${user.User_Status}')" style="margin-right:5px;">Edit</button>
            ${user.User_Status !== 'banned' ?
                `<button class="btn-outline btn-danger" onclick="banUser(${user.User_ID})">Ban</button>` :
                `<button class="btn-outline" onclick="unbanUser(${user.User_ID})">Unban</button>`
            }
          </td>
        </tr>
      `;
        }).join('');
    }

    function filterUsers() {
        const searchTerm = document.getElementById('user-search').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;
        let filtered = allUsers.filter(user => {
            const matchSearch = user.User_Username.toLowerCase().includes(searchTerm) || user.User_Email.toLowerCase().includes(searchTerm);
            const matchStatus = !statusFilter || user.User_Status === statusFilter;
            return matchSearch && matchStatus;
        });
        renderUsers(filtered);
    }

    function editUserStatus(userId, currentStatus) {
        const newStatus = prompt(`Current status: ${currentStatus}\n\nEnter new status (active/pending/banned):`, currentStatus);
        if (newStatus && ['active', 'pending', 'banned'].includes(newStatus.toLowerCase())) {
            updateUserStatus(userId, newStatus.toLowerCase());
        }
    }

    async function updateUserStatus(userId, newStatus) {
        try {
            const res = await fetch('../api/admin_update_user.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, status: newStatus })
            });
            const json = await res.json();
            if (json.success) {
                alert('User status updated successfully!');
                await loadUsers();
                await loadAdminData();
            } else {
                alert('Failed to update: ' + json.message);
            }
        } catch (err) {
            alert('Error updating user status');
        }
    }

    async function banUser(userId) {
        if (confirm('Are you sure you want to ban this user?')) { await updateUserStatus(userId, 'banned'); }
    }

    async function unbanUser(userId) {
        if (confirm('Are you sure you want to unban this user?')) { await updateUserStatus(userId, 'active'); }
    }

    function switchView(viewName, btnElement) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + viewName).classList.add('active');
        const allBtns = document.querySelectorAll('.sidebar-card button[onclick^="switchView"]');
        allBtns.forEach(btn => btn.classList.remove('active-view'));
        if (btnElement) { btnElement.classList.add('active-view'); }
    }

    function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function loadDepositStats() {
        try {
            const res = await fetch('../../Module_Transaction_Fund/api/Fund_Request.php?action=get_admin_statistics');
            const json = await res.json();
            if (json.success) {
                const data = json.data;
                document.getElementById('deposit-total').textContent = data.total_requests || 0;
                document.getElementById('deposit-pending').textContent = data.pending_requests || 0;
                document.getElementById('deposit-processed').textContent = data.processed_requests || 0;
            }
        } catch (err) { console.error("Failed to load deposit stats:", err); }
    }

    async function loadWithdrawalStats() {
        try {
            const res = await fetch('../../Module_Transaction_Fund/api/Fund_Request.php?action=get_admin_statistics&type=withdrawal');
            const json = await res.json();
            if (json.success) {
                const data = json.data;
                document.getElementById('withdrawal-total').textContent = data.total_requests || 0;
                document.getElementById('withdrawal-pending').textContent = data.pending_requests || 0;
                document.getElementById('withdrawal-processed').textContent = data.processed_requests || 0;
            }
        } catch (err) { console.error("Failed to load withdrawal stats:", err); }
    }

    async function handleLogout() {
        if(confirm("Are you sure you want to log out?")) { window.location.href = '../api/logout.php'; }
    }
</script>
</body>
</html>