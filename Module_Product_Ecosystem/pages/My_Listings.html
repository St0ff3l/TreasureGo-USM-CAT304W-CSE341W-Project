<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>My Listings - TreasureGO</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    /* ... (ä¿æŒä½ çš„åŸæœ‰ CSS æ ·å¼ä¸å˜) ... */
    :root {
      --bg-color: #F3F6F9;
      --primary: #4F46E5;
      --primary-hover: #4338CA;
      --text-dark: #1F2937;
      --text-gray: #6B7280;
      --glass-bg: rgba(255, 255, 255, 0.95);
      --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
      --danger: #EF4444;
      --status-green: #10B981;
      --status-orange: #F59E0B;
      --status-gray: #9CA3AF;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Poppins', 'Noto Sans SC', sans-serif; background: var(--bg-color); color: var(--text-dark); min-height: 100vh; padding-bottom: 80px; }

    /* Navbar */
    .navbar {
      background: var(--glass-bg); backdrop-filter: blur(12px); padding: 1rem 5%;
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid rgba(255,255,255,0.5);
    }
    .logo { font-weight: 800; font-size: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .logo span { color: var(--text-dark); }
    .logo-img { width: 42px; height: 42px; border-radius: 10px; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .nav-actions { display: flex; align-items: center; gap: 20px; }
    .nav-btn { border: none; background: transparent; font-weight: 600; color: var(--text-gray); padding: 0.6rem 0.5rem; cursor: pointer; transition: color 0.2s; font-size: 1rem; }
    .nav-btn:hover { color: var(--text-dark); }
    .menu-container { position: relative; display: inline-block; }
    .dots-btn { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; font-weight: bold; }

    /* Page Layout */
    .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .page-title { font-size: 1.8rem; font-weight: 800; }

    /* Publish Button */
    .btn-publish {
      background: var(--text-dark); color: white; padding: 10px 24px;
      border-radius: 30px; border: none; font-weight: 600; cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: transform 0.2s;
      display: flex; align-items: center; gap: 8px;
    }
    .btn-publish:hover { transform: translateY(-2px); background: black; }

    /* Tabs */
    .tabs-container {
      display: flex; gap: 12px; margin-bottom: 30px;
      overflow-x: auto; padding-bottom: 5px; scrollbar-width: none;
    }
    .tab-btn {
      padding: 8px 20px; border-radius: 25px; border: 1px solid transparent;
      background: white; color: var(--text-gray); font-weight: 600; font-size: 0.9rem;
      cursor: pointer; transition: 0.3s; box-shadow: var(--card-shadow);
      white-space: nowrap;
    }
    .tab-btn:hover { color: var(--primary); transform: translateY(-2px); }
    .tab-btn.active {
      background: var(--primary); color: white;
      box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);
    }
    .tab-count {
      display: inline-block; background: rgba(0,0,0,0.1);
      padding: 2px 6px; border-radius: 8px; font-size: 0.75rem; margin-left: 6px;
    }
    .tab-btn.active .tab-count { background: rgba(255,255,255,0.2); }

    /* Product Grid & Card */
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }

    .product-card {
      background: white; border-radius: 20px; box-shadow: var(--card-shadow); overflow: hidden;
      transition: 0.3s; position: relative; cursor: pointer; border: 2px solid transparent;
    }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }

    .card-img-container { height: 160px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); display: flex; align-items: center; justify-content: center; font-size: 3.5rem; transition: 0.3s; }
    .card-info { padding: 1.2rem; }
    .card-title { font-size: 1rem; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-dark); }
    .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-weight: 700; }
    .card-price { color: var(--primary); font-size: 1.1rem; }

    /* Status Badges */
    .status-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 12px; font-weight: 600; }
    .status-active { background: #ECFDF5; color: var(--status-green); }
    .status-review { background: #FFFBEB; color: var(--status-orange); }
    .status-sold { background: #F3F4F6; color: var(--text-dark); }
    .status-unlisted { background: #FEF2F2; color: var(--danger); }

    /* Action Button */
    .card-action-btn {
      position: absolute; top: 10px; right: 10px; width: 32px; height: 32px;
      background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center;
      color: var(--text-gray); font-size: 16px; cursor: pointer; z-index: 10; transition: 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .card-action-btn:hover { background: var(--primary); color: white; }

    /* Tab Content Logic */
    .tab-content { display: none; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; display: none; }
    .empty-icon { font-size: 4rem; margin-bottom: 20px; display: block; opacity: 0.5; }

    @media (max-width: 768px) {
      .product-grid { grid-template-columns: 1fr 1fr; gap: 15px; }
      .card-img-container { height: 140px; font-size: 3rem; }
    }
  </style>
</head>
<body>

<!-- Navbar replaced by headerbar.js -->
<script src="../../Public_Assets/js/headerbar.js"></script>
<script>TreasureGoHeaderbar.mount({ basePath: '../../' });</script>

<div class="container">
  <div class="page-header">
    <div class="page-title">My Listings</div>
    <button class="btn-publish" onclick="window.location.href='Publish_Page.html'">
      <span>+</span> Publish New
    </button>
  </div>

  <div class="tabs-container">
    <button class="tab-btn active" onclick="switchTab('active', this)">Active <span class="tab-count" id="count-active">0</span></button>
    <button class="tab-btn" onclick="switchTab('review', this)">Under Review <span class="tab-count" id="count-review">0</span></button>
    <button class="tab-btn" onclick="switchTab('sold', this)">Sold <span class="tab-count" id="count-sold">0</span></button>
    <button class="tab-btn" onclick="switchTab('inactive', this)">Inactive <span class="tab-count" id="count-inactive">0</span></button>
  </div>

  <div id="tab-active" class="tab-content active">
    <div class="product-grid" id="grid-active"></div>
    <div class="empty-state" id="empty-active"><span class="empty-icon">ğŸ“¦</span><p style="color:#999;">No active listings.</p></div>
  </div>
  <div id="tab-review" class="tab-content">
    <div class="product-grid" id="grid-review"></div>
    <div class="empty-state" id="empty-review"><span class="empty-icon">ğŸ“</span><p style="color:#999;">No items under review.</p></div>
  </div>
  <div id="tab-sold" class="tab-content">
    <div class="product-grid" id="grid-sold"></div>
    <div class="empty-state" id="empty-sold"><span class="empty-icon">ğŸ’°</span><p style="color:#999;">No sold items yet.</p></div>
  </div>
  <div id="tab-inactive" class="tab-content">
    <div class="product-grid" id="grid-inactive"></div>
    <div class="empty-state" id="empty-inactive"><span class="empty-icon">ğŸ—‘</span><h3>No inactive items</h3><p style="color:#999;">Items you unlist or delete will appear here.</p></div>
  </div>
</div>

<script>
  // --- ä¿®æ”¹å¼€å§‹ ---
  // ä½¿ç”¨ pageshow äº‹ä»¶ï¼Œå› ä¸ºå®ƒå¯ä»¥æ£€æµ‹åˆ°é€šè¿‡â€œåé€€â€æŒ‰é’®è¿”å›é¡µé¢çš„æƒ…å†µ
  window.addEventListener('pageshow', (event) => {
    // æ— è®ºæ˜¯é¦–æ¬¡åŠ è½½è¿˜æ˜¯ä»ç¼“å­˜(åé€€)åŠ è½½ï¼Œéƒ½é‡æ–°è·å–æ•°æ®
    fetchUserListings();
  });
  // --- ä¿®æ”¹ç»“æŸ ---

  function switchTab(tabId, btnElement) {
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    btnElement.classList.add('active');
  }

  const API_URL = '../api/Get_User_Listings.php';
  const DEFAULT_IMG = '../../Public_Assets/images/default_product.png';

  async function fetchUserListings() {
    try {
      // ä¿®æ”¹è¿™é‡Œï¼šç»™ URL åé¢åŠ ä¸€ä¸ªéšæœºæ—¶é—´æˆ³å‚æ•° (?t=...)
      // è¿™æ ·æ¯æ¬¡è¯·æ±‚ URL éƒ½ä¸ä¸€æ ·ï¼Œå¼ºåˆ¶æµè§ˆå™¨å‘æœåŠ¡å™¨è¯·æ±‚æœ€æ–°æ•°æ®
      const timestamp = new Date().getTime();
      const response = await fetch(`${API_URL}?t=${timestamp}`);

      const result = await response.json();

      if (result.success) {
        renderListings(result.data);
      } else {
        console.error('Error:', result.message);
        if(result.message === 'Not logged in') {
          alert("Please log in to view your listings.");
        }
      }
    } catch (error) {
      console.error('Fetch error:', error);
    }
  }

  function renderListings(products) {
    const grids = {
      'active': document.getElementById('grid-active'),
      'review': document.getElementById('grid-review'),
      'sold': document.getElementById('grid-sold'),
      'inactive': document.getElementById('grid-inactive')
    };
    const counts = { 'active': 0, 'review': 0, 'sold': 0, 'inactive': 0 };

    // æ¸…ç©ºç°æœ‰å†…å®¹
    for (let key in grids) { if(grids[key]) grids[key].innerHTML = ''; }

    products.forEach(item => {
      const dbStatus = (item.Product_Status || '').toLowerCase();

      // çŠ¶æ€æ˜ å°„é€»è¾‘
      let tabCategory = 'inactive';
      if (dbStatus === 'active') tabCategory = 'active';
      else if (dbStatus === 'unlisted') tabCategory = 'inactive';
      else if (dbStatus === 'sold') tabCategory = 'sold';
      else if (dbStatus === 'pending' || dbStatus === 'review') tabCategory = 'review';

      if (grids[tabCategory]) {
        counts[tabCategory]++;

        // å›¾ç‰‡è·¯å¾„å¤„ç† (ä¿æŒä½ ä¹‹å‰çš„æ­£åˆ™é€»è¾‘)
        let imgUrl = DEFAULT_IMG;
        if (item.Main_Image) {
          const cleanPath = item.Main_Image.replace(/^.*?Public_Product_Images\//, 'Public_Product_Images/');
          imgUrl = '../' + cleanPath;
        }

        // ğŸ”¥ğŸ”¥ğŸ”¥ ä¿®æ”¹é‡ç‚¹åœ¨è¿™é‡Œ ğŸ”¥ğŸ”¥ğŸ”¥
        // 1. åœ¨ class="product-card" åé¢åŠ ä¸Šäº† onclick è·³è½¬
        // 2. è·³è½¬åœ°å€æ˜¯ Seller_Product_Management.html?id=å•†å“ID
        const cardHtml = `
          <div class="product-card" onclick="window.location.href='Seller_Product_Management.html?id=${item.Product_ID}'">

            <div class="card-action-btn" onclick="event.stopPropagation(); handleAction('${item.Product_ID}', '${dbStatus}')">
              ${getActionIcon(dbStatus)}
            </div>

            <div class="card-img-container">
              <img src="${imgUrl}"
                   alt="${item.Product_Title}"
                   style="width:100%; height:100%; object-fit:cover;"
                   onerror="this.src='${DEFAULT_IMG}'">
            </div>

            <div class="card-info">
              <h4 class="card-title">${item.Product_Title}</h4>
              <div class="card-footer">
                <span class="card-price">$${item.Product_Price}</span>
                <span class="status-badge status-${dbStatus}">${capitalize(dbStatus)}</span>
              </div>
            </div>
          </div>
        `;
        grids[tabCategory].innerHTML += cardHtml;
      }
    });

    updateTabCounts(counts);
    checkEmptyStates(counts);
  }

  // ... (getActionIcon ä¸éœ€è¦åŠ¨) ...
  function getActionIcon(status) {
    if (status === 'active') return 'âœ';
    if (status === 'unlisted') return 'ğŸš€';
    if (status === 'sold') return 'ğŸ“„';
    return 'ğŸ‘';
  }

  // ğŸ”¥ğŸ”¥ğŸ”¥ ä¿®æ”¹é‡ç‚¹ 2ï¼šå°å›¾æ ‡ç‚¹å‡»ä¹Ÿè·³è½¬åˆ°ç®¡ç†é¡µ ğŸ”¥ğŸ”¥ğŸ”¥
  function handleAction(id, status) {
    // æ— è®ºæ˜¯ Active, Unlisted è¿˜æ˜¯å…¶ä»–çŠ¶æ€ï¼Œç‚¹å‡»éƒ½å»ç®¡ç†é¡µé¢
    window.location.href = `Seller_Product_Management.html?id=${id}`;
  }

  // ... (capitalize, updateTabCounts, checkEmptyStates ç­‰è¾…åŠ©å‡½æ•°ä¿æŒä¸å˜) ...
  function capitalize(str) {
    if(!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  function updateTabCounts(counts) {
    if(document.getElementById('count-active')) document.getElementById('count-active').innerText = counts.active;
    if(document.getElementById('count-review')) document.getElementById('count-review').innerText = counts.review;
    if(document.getElementById('count-sold')) document.getElementById('count-sold').innerText = counts.sold;
    if(document.getElementById('count-inactive')) document.getElementById('count-inactive').innerText = counts.inactive;
  }

  function checkEmptyStates(counts) {
    toggleDisplay('active', counts.active);
    toggleDisplay('review', counts.review);
    toggleDisplay('sold', counts.sold);
    toggleDisplay('inactive', counts.inactive);
  }

  function toggleDisplay(type, count) {
    const grid = document.getElementById(`grid-${type}`);
    const empty = document.getElementById(`empty-${type}`);
    if(grid && empty) {
      if(count > 0) {
        grid.style.display = 'grid';
        empty.style.display = 'none';
      } else {
        grid.style.display = 'none';
        empty.style.display = 'block';
      }
    }
  }
</script>

</body>
</html>