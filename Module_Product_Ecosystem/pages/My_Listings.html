<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>My Listings - TreasureGO</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    /* ========================================= */
    /* æ ·å¼éƒ¨åˆ† (å®Œå…¨ä¿ç•™ä½ çš„åŸæ ·å¼) */
    /* ========================================= */
    :root {
      --bg-color: #F3F6F9;
      --primary: #4F46E5;
      --primary-hover: #4338CA;
      --text-dark: #1F2937;
      --text-gray: #6B7280;
      --glass-bg: rgba(255, 255, 255, 0.95);
      --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
      --danger: #EF4444;
      --status-green: #10B981;
      --status-orange: #F59E0B;
      --status-gray: #9CA3AF;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Poppins', 'Noto Sans SC', sans-serif; background: var(--bg-color); color: var(--text-dark); min-height: 100vh; padding-bottom: 80px; }

    /* Navbar */
    .navbar {
      background: var(--glass-bg); backdrop-filter: blur(12px); padding: 1rem 5%;
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid rgba(255,255,255,0.5);
    }
    .logo { font-weight: 800; font-size: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .logo span { color: var(--text-dark); }
    .logo-img { width: 42px; height: 42px; border-radius: 10px; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .nav-actions { display: flex; align-items: center; gap: 20px; }
    .nav-btn { border: none; background: transparent; font-weight: 600; color: var(--text-gray); padding: 0.6rem 0.5rem; cursor: pointer; transition: color 0.2s; font-size: 1rem; }
    .nav-btn:hover { color: var(--text-dark); }
    .menu-container { position: relative; display: inline-block; }
    .dots-btn { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; font-weight: bold; }

    /* Page Layout */
    .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .page-title { font-size: 1.8rem; font-weight: 800; }

    /* Publish Button */
    .btn-publish {
      background: var(--text-dark); color: white; padding: 10px 24px;
      border-radius: 30px; border: none; font-weight: 600; cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: transform 0.2s;
      display: flex; align-items: center; gap: 8px;
    }
    .btn-publish:hover { transform: translateY(-2px); background: black; }

    /* Tabs */
    .tabs-container {
      display: flex; gap: 12px; margin-bottom: 30px;
      overflow-x: auto; padding-bottom: 5px; scrollbar-width: none;
    }
    .tab-btn {
      padding: 8px 20px; border-radius: 25px; border: 1px solid transparent;
      background: white; color: var(--text-gray); font-weight: 600; font-size: 0.9rem;
      cursor: pointer; transition: 0.3s; box-shadow: var(--card-shadow);
      white-space: nowrap;
    }
    .tab-btn:hover { color: var(--primary); transform: translateY(-2px); }
    .tab-btn.active {
      background: var(--primary); color: white;
      box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);
    }
    .tab-count {
      display: inline-block; background: rgba(0,0,0,0.1);
      padding: 2px 6px; border-radius: 8px; font-size: 0.75rem; margin-left: 6px;
    }
    .tab-btn.active .tab-count { background: rgba(255,255,255,0.2); }

    /* Product Grid & Card */
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }

    .product-card {
      background: white; border-radius: 20px; box-shadow: var(--card-shadow); overflow: hidden;
      transition: 0.3s; position: relative; cursor: pointer; border: 2px solid transparent;
    }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }

    .card-img-container {
      height: 160px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3.5rem;
      transition: 0.3s;
      /* å¿…é¡»è®¾ç½®ä¸º relative ä»¥ä¾¿æ”¾ç½®å°ç«  */
      position: relative;
    }

    .card-info { padding: 1.2rem; }
    .card-title { font-size: 1rem; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-dark); }
    .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-weight: 700; }
    .card-price { color: var(--primary); font-size: 1.1rem; }

    /* Status Badges */
    .status-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 12px; font-weight: 600; }
    .status-active { background: #ECFDF5; color: var(--status-green); }
    .status-review { background: #FFFBEB; color: var(--status-orange); }
    .status-sold { background: #F3F4F6; color: var(--text-dark); }
    .status-unlisted { background: #FEF2F2; color: var(--danger); }

    /* Action Button */
    .card-action-btn {
      position: absolute; top: 10px; right: 10px; width: 32px; height: 32px;
      background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center;
      color: var(--text-gray); font-size: 16px; cursor: pointer; z-index: 10; transition: 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .card-action-btn:hover { background: var(--primary); color: white; }

    /* Tab Content Logic */
    .tab-content { display: none; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; display: none; }
    .empty-state.visible { display: block; }
    .empty-icon { font-size: 4rem; margin-bottom: 20px; display: block; opacity: 0.5; }

    /* --- å·²å”®å‡ºå•†å“æ ·å¼ --- */
    .product-card.sold-item .card-img-container img {
      filter: grayscale(100%); /* å›¾ç‰‡å˜ç° */
      opacity: 0.5;            /* å›¾ç‰‡å˜æ·¡ */
    }

    .product-card.sold-item .card-img-container::after {
      content: 'SOLD OUT';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-15deg);
      border: 4px solid rgba(80, 80, 80, 0.7);
      color: rgba(80, 80, 80, 0.9);
      font-weight: 900;
      font-size: 1.4rem;
      padding: 5px 15px;
      text-transform: uppercase;
      letter-spacing: 2px;
      border-radius: 8px;
      background-color: rgba(255, 255, 255, 0.5);
      z-index: 5;
      pointer-events: none;
    }

    @media (max-width: 768px) {
      .product-grid { grid-template-columns: 1fr 1fr; gap: 15px; }
      .card-img-container { height: 140px; font-size: 3rem; }
      /* æ‰‹æœºç«¯é€‚å½“è°ƒå°å°ç« å­—ä½“ */
      .product-card.sold-item .card-img-container::after {
        font-size: 1.1rem;
        padding: 4px 10px;
        border-width: 3px;
      }

      /* ========================================= */
      /* âœ… Tabs mobile layout: æ–¹æ¡ˆ Bï¼ˆä¸¤è¡Œæ¢è¡Œï¼Œä¸æ»šåŠ¨ï¼‰ */
      /* æ³¨æ„ï¼šåªåœ¨æ‰‹æœºç«¯ç”Ÿæ•ˆï¼Œä¸å½±å“æ¡Œé¢ç«¯ */
      /* ========================================= */

      .tabs-container {
        /* å…³é—­æ¨ªå‘æ»šåŠ¨ï¼Œæ”¹ä¸ºä¸¤è¡Œæ¢è¡Œ */
        overflow-x: hidden;
        overflow-y: hidden;

        display: flex;
        flex-wrap: wrap;
        gap: 10px;

        /* å…³é”®ï¼šé™åˆ¶æœ€å¤šä¸¤è¡Œï¼ˆç¬¬äºŒè¡Œä¹‹åéšè—ï¼‰ï¼Œé¿å…æŠŠé¡µé¢é¡¶å¾—å¤ªé•¿ */
        /* tab é«˜åº¦çº¦ 38-40pxï¼Œä¸¤è¡Œ+gap çº¦ 86-92pxï¼Œå–ä¸€ä¸ªå®‰å…¨å€¼ */
        max-height: 96px;

        /* å»æ‰ä¹‹å‰ç”¨äºæ»šåŠ¨ä½“éªŒçš„è®¾ç½® */
        -webkit-overflow-scrolling: auto;
        scroll-snap-type: none;

        /* å»æ‰â€œè¾¹ç¼˜è£åˆ‡â€é‚£å¥—æ»šåŠ¨è¡¥ä¸ */
        padding-left: 0;
        padding-right: 0;
        margin-left: 0;
        margin-right: 0;

        align-items: stretch;
      }

      .tab-btn {
        /* è®©æ¯ä¸ªæŒ‰é’®åœ¨ä¸¤è¡Œå¸ƒå±€é‡Œæ›´å¹³å‡ */
        flex: 1 1 auto;
        min-width: 140px; /* ç¡®ä¿ Under Review/Rejected ä¸ä¼šæŒ¤æˆå¾ˆå¥‡æ€ª */

        /* ç»´æŒå•è¡Œæ–‡å­—ï¼Œä¸è®©æŒ‰é’®å†…éƒ¨æ¢è¡Œ */
        white-space: nowrap;

        /* ç§»é™¤æ»šåŠ¨å¸é™„ */
        scroll-snap-align: none;

        /* é€‚é…ä¸¤è¡Œå¸ƒå±€çš„æŒ‰é’®å°ºå¯¸ */
        padding: 9px 14px;
        font-size: 0.88rem;
        text-align: center;
      }

      .tab-count {
        padding: 2px 6px;
        margin-left: 6px;
        font-size: 0.72rem;
      }
    }

    /* æ›´å°å±è¿›ä¸€æ­¥ä¼˜åŒ–ï¼šè®© tab æ›´ç´§å‡‘ï¼Œé¿å…ä¸€å±æ˜¾ç¤ºä¸ä¸‹ */
    @media (max-width: 420px) {
      .container { padding: 0 14px; }
      .page-title { font-size: 1.55rem; }

      .tabs-container { gap: 8px; max-height: 92px; }
      .tab-btn { min-width: 120px; padding: 8px 12px; font-size: 0.82rem; }
      .tab-count { font-size: 0.7rem; padding: 2px 5px; }
    }
  </style>
</head>
<body>

<script src="../../Public_Assets/js/headerbar.js"></script>
<script>TreasureGoHeaderbar.mount({ basePath: '../../' });</script>

<div class="container">
  <div class="page-header">
    <div class="page-title">My Listings</div>
    <button class="btn-publish" onclick="window.location.href='Publish_Page.html'">
      <span>+</span> Publish New
    </button>
  </div>

  <div class="tabs-container">
    <button class="tab-btn active" onclick="switchTab('active', this)">Active <span class="tab-count" id="count-active">0</span></button>
    <button class="tab-btn" onclick="switchTab('review', this)">Under Review <span class="tab-count" id="count-review">0</span></button>
    <button class="tab-btn" onclick="switchTab('unlisted', this)">Unlisted <span class="tab-count" id="count-unlisted">0</span></button>
    <button class="tab-btn" onclick="switchTab('rejected', this)">Rejected <span class="tab-count" id="count-rejected">0</span></button>
    <button class="tab-btn" onclick="switchTab('sold', this)">Sold <span class="tab-count" id="count-sold">0</span></button>
  </div>

  <div id="tab-active" class="tab-content active">
    <div class="product-grid" id="grid-active"></div>
    <div class="empty-state" id="empty-active">
      <span class="empty-icon">ğŸ›ï¸</span>
      <h3>No active listings</h3>
      <p style="color:var(--text-gray); margin-top:10px;">Your items for sale will appear here.</p>
    </div>
  </div>

  <div id="tab-review" class="tab-content">
    <div class="product-grid" id="grid-review"></div>
    <div class="empty-state" id="empty-review">
      <span class="empty-icon">â³</span>
      <h3>No items under review</h3>
      <p style="color:var(--text-gray); margin-top:10px;">Items waiting for approval will appear here.</p>
    </div>
  </div>

  <div id="tab-unlisted" class="tab-content">
    <div class="product-grid" id="grid-unlisted"></div>
    <div class="empty-state" id="empty-unlisted">
      <span class="empty-icon">ğŸ“</span>
      <h3>No unlisted items</h3>
      <p style="color:var(--text-gray); margin-top:10px;">Drafts and hidden items will appear here.</p>
    </div>
  </div>

  <div id="tab-rejected" class="tab-content">
    <div class="product-grid" id="grid-rejected"></div>
    <div class="empty-state" id="empty-rejected">
      <span class="empty-icon">âš ï¸</span>
      <h3>No rejected items</h3>
      <p style="color:var(--text-gray); margin-top:10px;">Items that need changes will appear here.</p>
    </div>
  </div>

  <div id="tab-sold" class="tab-content">
    <div class="product-grid" id="grid-sold"></div>
    <div class="empty-state" id="empty-sold">
      <span class="empty-icon">ğŸ’°</span>
      <h3>No sold items yet</h3>
      <p style="color:var(--text-gray); margin-top:10px;">Your sold items history will appear here.</p>
    </div>
  </div>
</div>

<script>
  window.addEventListener('pageshow', (event) => {
    fetchUserListings();
  });

  function switchTab(tabId, btnElement) {
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    btnElement.classList.add('active');
  }

  const API_URL = '../api/Get_User_Listings.php';
  const DEFAULT_IMG = '../../Public_Assets/images/default_product.png';

  async function fetchUserListings() {
    try {
      const timestamp = new Date().getTime();
      const response = await fetch(`${API_URL}?t=${timestamp}`);
      const result = await response.json();

      if (result.success) {
        renderListings(result.data);
      } else {
        console.error('Error:', result.message);
        if(result.message === 'Not logged in') {
          // window.location.href = '../../Module_User_Account_Management/pages/login.php';
          alert("Please log in to view your listings.");
        }
      }
    } catch (error) {
      console.error('Fetch error:', error);
    }
  }

  // ğŸ”¥ æ ¸å¿ƒæ¸²æŸ“å‡½æ•° ğŸ”¥
  function renderListings(products) {
    const groups = {
      active: [],
      review: [],
      unlisted: [],
      rejected: [],
      sold: []
    };

    products.forEach(item => {
      const sellerStatus = (item.Product_Status || '').toLowerCase();
      const reviewStatus = (item.Product_Review_Status || 'pending').toLowerCase();

      // ä¼˜å…ˆçº§åˆ¤æ–­
      if (sellerStatus === 'sold') {
        groups.sold.push(item);
      } else if (reviewStatus === 'rejected') {
        groups.rejected.push(item);
      } else if (sellerStatus === 'unlisted') {
        groups.unlisted.push(item);
      } else if (reviewStatus === 'pending') {
        groups.review.push(item);
      } else if (reviewStatus === 'approved' && sellerStatus === 'active') {
        groups.active.push(item);
      } else {
        groups.unlisted.push(item);
      }
    });

    // æ›´æ–°è®¡æ•°
    document.getElementById('count-active').textContent = groups.active.length;
    document.getElementById('count-review').textContent = groups.review.length;
    document.getElementById('count-unlisted').textContent = groups.unlisted.length;
    document.getElementById('count-rejected').textContent = groups.rejected.length;
    document.getElementById('count-sold').textContent = groups.sold.length;

    // æ¸²æŸ“ç½‘æ ¼
    renderGrid('grid-active', 'empty-active', groups.active, 'Active');
    renderGrid('grid-review', 'empty-review', groups.review, 'Under Review');
    renderGrid('grid-unlisted', 'empty-unlisted', groups.unlisted, 'Unlisted');
    renderGrid('grid-rejected', 'empty-rejected', groups.rejected, 'Rejected');
    renderGrid('grid-sold', 'empty-sold', groups.sold, 'Sold');
  }

  function renderGrid(containerId, emptyId, items, statusLabel) {
    const container = document.getElementById(containerId);
    const emptyState = document.getElementById(emptyId);

    if (!container || !emptyState) return;

    container.innerHTML = '';

    if (items.length === 0) {
      container.style.display = 'none';
      emptyState.classList.add('visible');
      return;
    }

    container.style.display = 'grid';
    emptyState.classList.remove('visible');

    items.forEach(item => {
      let imgUrl = DEFAULT_IMG;
      if (item.Main_Image) {
        const cleanPath = item.Main_Image.replace(/^.*?Public_Product_Images\//, 'Public_Product_Images/');
        imgUrl = '../' + cleanPath;
      }

      let badgeClass = 'status-active';
      if(statusLabel === 'Sold') badgeClass = 'status-sold';
      else if(statusLabel === 'Rejected' || statusLabel === 'Unlisted') badgeClass = 'status-unlisted';
      else if(statusLabel === 'Under Review') badgeClass = 'status-review';

      const soldCssClass = (statusLabel === 'Sold') ? 'sold-item' : '';

      // ğŸ”¥ ä¿®æ”¹å¤„ï¼šç°åœ¨æ— è®ºæ˜¯å¦å–å‡ºï¼Œéƒ½æŒ‡å‘ Seller_Product_Management.html
      const targetPage = 'Seller_Product_Management.html';

      const cardHtml = `
          <div class="product-card ${soldCssClass}" onclick="window.location.href='${targetPage}?id=${item.Product_ID}'">
            <div class="card-action-btn" onclick="event.stopPropagation(); handleAction('${item.Product_ID}')">
              âœ
            </div>
            <div class="card-img-container">
              <img src="${imgUrl}"
                   alt="${item.Product_Title}"
                   style="width:100%; height:100%; object-fit:cover;"
                   onerror="this.onerror=null; this.src='${DEFAULT_IMG}'">
            </div>
            <div class="card-info">
              <h4 class="card-title">${item.Product_Title}</h4>
              <div class="card-footer">
                <span class="card-price">RM${parseFloat(item.Product_Price).toFixed(2)}</span>
                <span class="status-badge ${badgeClass}">${statusLabel}</span>
              </div>
            </div>
          </div>
        `;
      container.innerHTML += cardHtml;
    });
  }

  function handleAction(id) {
    window.location.href = `Seller_Product_Management.html?id=${id}`;
  }
</script>

</body>
</html>