<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Detail - TreasureGO</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- 1. Global Styles --- */
        :root {
            --bg-color: #F3F6F9;
            --primary: #4F46E5;
            --primary-hover: #4338CA;
            --text-dark: #1F2937;
            --text-gray: #6B7280;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
            --success: #10B981;
            --warning: #F59E0B;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-dark);
            min-height: 100vh;
            padding-bottom: 50px;
        }

        /* --- 2. Navbar --- */
        .navbar {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.5);
        }

        .logo { font-weight: 800; font-size: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 10px; text-decoration: none; }
        .logo span { color: var(--text-dark); }
        .logo-img { width: 42px; height: 42px; border-radius: 10px; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .nav-actions { display: flex; align-items: center; gap: 20px; }
        .nav-btn { border: none; background: transparent; font-weight: 600; color: var(--text-gray); padding: 0.6rem 0.5rem; cursor: pointer; transition: color 0.2s; font-size: 1rem; }
        .nav-btn:hover { color: var(--text-dark); }

        .btn-primary { border: none; background-color: var(--text-dark); color: white; font-weight: 600; padding: 0.7rem 1.8rem; border-radius: 12px; cursor: pointer; transition: all 0.2s; font-size: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary:hover { transform: translateY(-2px); background-color: #000; }

        .menu-container { position: relative; display: inline-block; }
        .dots-btn { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; color: var(--text-dark); font-weight: bold; padding-bottom: 6px; transition: 0.2s; }
        .dots-btn:hover { background: #eee; }
        .dropdown-content { display: none; position: absolute; right: 0; top: 130%; background-color: white; min-width: 160px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); border-radius: 16px; z-index: 1001; padding: 8px; }
        .menu-container:hover .dropdown-content { display: block; }
        .dropdown-item { color: var(--text-dark); padding: 12px 16px; text-decoration: none; display: block; font-size: 14px; font-weight: 500; border-radius: 10px; }
        .dropdown-item:hover { background-color: #f3f4f6; color: var(--primary); }

        /* --- 3. Breadcrumb & Layout --- */
        .breadcrumb { max-width: 1100px; margin: 20px auto; padding: 0 20px; font-size: 0.9rem; color: var(--text-gray); }
        .breadcrumb a { text-decoration: none; color: var(--text-gray); }

        .product-container { max-width: 1100px; margin: 0 auto; padding: 0 20px; display: grid; grid-template-columns: 1.2fr 1fr; gap: 50px; align-items: start; }

        /* --- Gallery Styles (Updated to Match Source) --- */
        .gallery-wrapper { position: sticky; top: 100px; }

        .main-image-box {
            width: 100%; height: 500px; background: white; border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 8rem; box-shadow: var(--card-shadow); margin-bottom: 15px;
            position: relative; overflow: hidden; /* é˜²æ­¢å›¾ç‰‡æº¢å‡ºåœ†è§’ */
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* ğŸ”¥ Updated Arrow Styles */
        .nav-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 44px; height: 44px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%; border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; color: var(--text-dark); z-index: 10;
            transition: all 0.2s ease;
            opacity: 0; /* Default hidden */
        }
        .main-image-box:hover .nav-arrow { opacity: 1; } /* Show on hover */
        .nav-arrow:hover { background: var(--primary); color: white; transform: translateY(-50%) scale(1.1); }

        .prev-btn { left: 15px; }
        .next-btn { right: 15px; }

        /* ğŸ”¥ Added Fade Animation */
        .fade-anim {
            animation: fadeScale 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        @keyframes fadeScale {
            from { opacity: 0.6; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        .thumbnails { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .thumb {
            width: 80px; height: 80px; background: white; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; border: 2px solid transparent; cursor: pointer;
            flex-shrink: 0; overflow: hidden; transition: all 0.2s;
        }
        .thumb img { width: 100%; height: 100%; object-fit: cover; }
        .thumb.active { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }

        /* Info */
        .product-info { padding-top: 10px; }

        .tag-report-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 15px;
        }

        .product-tag {
            display: inline-block;
            background: #DEF7EC;
            color: var(--success);
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .report-inline-btn {
            height: 36px;
            padding: 0 12px;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            color: #9CA3AF;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .report-text { font-size: 0.9rem; font-weight: 600; }
        .report-icon { font-size: 1.1rem; }

        .report-inline-btn:hover {
            color: #EF4444;
            border-color: #EF4444;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);
        }

        .product-title { font-size: 2.2rem; font-weight: 800; line-height: 1.2; margin-bottom: 10px; }
        .product-price { font-size: 2rem; color: var(--primary); font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .original-price { font-size: 1.2rem; color: #ccc; text-decoration: line-through; font-weight: 400; }

        /* Badges */
        .delivery-badges { display: flex; gap: 10px; margin-bottom: 30px; }
        .badge { padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .badge-meet { background: #ECFDF5; color: #059669; }
        .badge-ship { background: #EEF2FF; color: #4F46E5; }

        /* Seller & Location */
        .seller-card { background: white; padding: 20px; border-radius: 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 25px; border: 1px solid rgba(0,0,0,0.03); }
        .seller-info { display: flex; align-items: center; gap: 15px; }
        .seller-avatar { width: 50px; height: 50px; background: #ddd; border-radius: 50%; font-size: 25px; display: flex; align-items: center; justify-content: center; }
        .chat-btn-small { background: #f0f0f0; color: var(--text-dark); border: none; padding: 8px 16px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; }

        .location-box { display: flex; align-items: center; gap: 12px; background: #f9f9fb; padding: 14px 16px; border-radius: 16px; margin-bottom: 30px; border: 1px solid #eee; color: var(--text-dark); font-size: 0.95rem; font-weight: 500; }

        .description-text { color: var(--text-gray); line-height: 1.7; font-size: 1rem; margin-bottom: 40px; }

        /* Actions */
        .action-buttons { display: flex; gap: 15px; margin-top: 20px; }
        .btn-buy { flex: 1; background: var(--primary); color: white; border: none; padding: 18px; border-radius: 16px; font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3); transition: 0.2s; text-align: center; text-decoration: none; }
        .btn-buy:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn-fav { width: 60px; background: white; border: 2px solid #eee; border-radius: 16px; font-size: 1.5rem; cursor: pointer; color: #ccc; transition: 0.2s; }
        .btn-fav.active { background: #fef2f2; border-color: #ef4444; color: #ef4444; }

        .safety-box { margin-top: 30px; background: #EFF6FF; border-radius: 16px; padding: 20px; color: #1E40AF; font-size: 0.9rem; display: flex; gap: 10px; align-items: center; }

        /* Toast */
        .toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 10000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        .toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        @media (max-width: 768px) {
            .product-container { grid-template-columns: 1fr; gap: 30px; }
            .gallery-wrapper { position: static; }
            .main-image-box { height: 350px; }
            .product-title { font-size: 1.8rem; }
            .nav-arrow { opacity: 1; width: 36px; height: 36px; }
        }
    </style>
</head>
<body>

<script src="../../Public_Assets/js/headerbar.js"></script>

<script>
    // 1. ğŸ”¥ å®šä¹‰å…¨å±€ AuthModal (é€‚é…å½“å‰é¡µé¢çš„è·¯å¾„)
    // å¿…é¡»å®šä¹‰åœ¨ window ä¸Šï¼Œheaderbar.js æ‰èƒ½æ‰¾åˆ°å®ƒ
    window.AuthModal = {
        htmlContent: `
            <dialog id="globalLoginDialog" class="tg-auth-modal">
                <div style="font-size: 40px; margin-bottom: 10px;">ğŸ”’</div>
                <h3 style="margin-bottom:10px; color: #1F2937; font-size: 1.2rem; font-family: 'Poppins', sans-serif;">Login Required</h3>
                <p style="margin-bottom:25px; color:#6B7280; font-size: 0.95rem; line-height: 1.5; font-family: 'Poppins', sans-serif;">
                    You need to log in to access this feature.
                </p>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button onclick="window.AuthModal.close()"
                            style="padding:10px 20px; border:1px solid #E5E7EB; background:white; color: #374151; border-radius:12px; cursor:pointer; font-weight: 600;">
                        Cancel
                    </button>
                    <button onclick="window.location.href='../../Module_User_Account_Management/pages/login.php'"
                            style="padding:10px 20px; border:none; background:#4F46E5; color:white; border-radius:12px; cursor:pointer; font-weight: 600;">
                        Go to Login
                    </button>
                </div>
            </dialog>
        `,
        init: function() {
            if (document.getElementById('globalLoginDialog')) return;
            const style = document.createElement('style');
            style.innerHTML = `
                .tg-auth-modal::backdrop { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); }
                .tg-auth-modal {
                    position: fixed; top: 30%; bottom: auto; left: 0; right: 0; margin: 0 auto;
                    border-radius: 24px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.15);
                    text-align: center; width: 320px; border: none; outline: none;
                    animation: tgSlideDown 0.4s cubic-bezier(0.25, 1, 0.5, 1);
                    z-index: 10000;
                }
                @keyframes tgSlideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
            `;
            document.head.appendChild(style);
            document.body.insertAdjacentHTML('beforeend', this.htmlContent);
        },
        show: function() {
            this.init();
            const dialog = document.getElementById('globalLoginDialog');
            if (dialog) dialog.showModal();
        },
        close: function() {
            const dialog = document.getElementById('globalLoginDialog');
            if (dialog) dialog.close();
        }
    };

    // 2. ğŸ”¥ æŒ‚è½½ Headerbar (å¿…é¡»åœ¨å®šä¹‰ AuthModal ä¹‹å)
    TreasureGoHeaderbar.mount({ basePath: '../../' });
</script>

<div class="breadcrumb">
    <a href="../../index.html">Home</a> &gt; <span>Digital</span> &gt; <span>Product Detail</span>
</div>

<div class="product-container">
    <div class="gallery-wrapper">
        <div class="main-image-box" id="mainImage">
            <div style="font-size:5rem;">ğŸ“¦</div>
        </div>
        <div class="thumbnails">
        </div>
    </div>

    <div class="product-info">
        <div class="tag-report-wrapper">
            <div class="product-tag">Condition: Loading...</div>
            <a href="../../Module_Platform_Governance_AI_Services/pages/report.html" class="report-inline-btn" id="reportBtn" title="Report this item">
                <span class="report-text">Report</span>
                <span class="report-icon">ğŸ´</span>
            </a>
        </div>

        <h1 class="product-title">Loading Product...</h1>
        <div class="product-price">$0.00</div>

        <div class="delivery-badges">
            Loading Options...
        </div>

        <div class="seller-card">
            <div class="seller-info">
                <div class="seller-avatar">ğŸ‘¤</div>
                <div class="seller-details">
                    <h4>Loading...</h4>
                    <div class="seller-rating">...</div>
                </div>
            </div>
            <button class="chat-btn-small" onclick="showToast('ğŸ’¬ Opening Chat...')">Chat</button>
        </div>

        <div class="location-box">
            <span style="font-size: 1.3rem;">ğŸ“</span>
            <div><span style="display:block; color:#666; font-size:0.85rem;">Seller Location:</span><strong>Loading...</strong></div>
        </div>

        <h3 class="section-title">Description</h3>
        <p class="description-text">
            Loading description...
        </p>

        <div class="action-buttons">
            <button class="btn-fav" id="favBtn" onclick="toggleFav()">â™¥</button>
            <a href="Order_Confirmation.html" class="btn-buy">Buy Now</a>
        </div>

        <div class="safety-box">
            <span style="font-size: 1.5rem;">ğŸ›¡ï¸</span>
            <div><strong>Treasure Safety Tip:</strong><br>For meet-ups, please choose a safe public location.</div>
        </div>
    </div>
</div>

<div id="toast" class="toast">Action Successful</div>

<script>
    // 1. è·å– URL ä¸­çš„å•†å“ ID
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');

    // å…¨å±€å˜é‡ for Images
    let globalImageList = [];
    let currentImageIndex = 0;

    // ğŸ”¥æ–°å¢ï¼šä¿å­˜å½“å‰å•†å“ä¿¡æ¯ï¼Œç»™ Report è·³è½¬ç”¨
    let currentProductForReport = null;

    // 2. åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        if (!productId) {
            alert("Product not found!");
            window.location.href = '../../index.html';
            return;
        }

        // åŠ è½½è¯¦æƒ…
        loadProductDetails(productId);

        // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šåŠ è½½æ”¶è—çŠ¶æ€ ğŸ”¥
        checkFavoriteStatus();
    });

    // 3. åŠ è½½å•†å“è¯¦æƒ…
    async function loadProductDetails(id) {
        try {
            const response = await fetch(`../api/Get_Products.php?product_id=${id}`);
            const result = await response.json();

            if (result.success && result.data.length > 0) {
                const product = result.data[0];
                renderProduct(product);
            } else {
                alert("Product details not found.");
            }
        } catch (error) {
            console.error("Error loading product:", error);
        }
    }

    // 4. æ¸²æŸ“é¡µé¢
    function renderProduct(item) {
        // --- åŸºç¡€ä¿¡æ¯æ¸²æŸ“ (ä¿æŒä¸å˜) ---
        document.querySelector('.product-title').innerText = item.Product_Title;
        document.querySelector('.product-price').innerHTML = `$${parseFloat(item.Product_Price).toFixed(2)}`;

        // --- ğŸ”¥ ä¿®æ”¹ç‚¹ï¼šåŠ¨æ€æ¸²æŸ“äº¤æ˜“æ–¹å¼æ ‡ç­¾ (START) ğŸ”¥ ---
        const badgesContainer = document.querySelector('.delivery-badges');
        badgesContainer.innerHTML = ''; // æ¸…ç©ºåŸæœ‰å†…å®¹

        // è·å– Delivery_Method å­—æ®µ (meetup, shipping, both)
        const method = item.Delivery_Method;

        if (method === 'meetup' || method === 'both') {
            badgesContainer.innerHTML += `<span class="badge badge-meet">ğŸ¤ Meet-up Available</span>`;
        }

        if (method === 'shipping' || method === 'both') {
            badgesContainer.innerHTML += `<span class="badge badge-ship">ğŸšš Shipping Available</span>`;
        }
        // --- ğŸ”¥ ä¿®æ”¹ç‚¹ï¼šåŠ¨æ€æ¸²æŸ“äº¤æ˜“æ–¹å¼æ ‡ç­¾ (END) ğŸ”¥ ---

        item.Product_Description ? document.querySelector('.description-text').innerText = item.Product_Description : document.querySelector('.description-text').innerText = "No description available.";
        document.querySelector('.product-tag').innerText = `Condition: ${item.Product_Condition}`;
        const location = item.Product_Location || 'Unknown Location';
        document.querySelector('.location-box div strong').innerText = location;
        document.querySelector('.seller-details h4').innerText = item.User_Username;
        const rating = item.User_Average_Rating ? `â˜… ${item.User_Average_Rating}` : 'New Seller';
        document.querySelector('.seller-rating').innerText = rating;

        const buyBtn = document.querySelector('.btn-buy');
        const conditionTag = document.querySelector('.product-tag'); // è·å–æ ‡ç­¾ä»¥ä¾¿ä¿®æ”¹é¢œè‰²

        // æ ¸å¿ƒåˆ¤æ–­ï¼šå¦‚æœæ˜¯ Sold (å·²å”®å‡º)
        if (item.Product_Status === 'Sold' || item.Product_Status === 'Inactive') {
            // 1. æŒ‰é’®å˜ç°ã€æ”¹æ–‡å­—ã€ç¦ç”¨
            buyBtn.innerText = "Sold Out";
            buyBtn.style.background = "#9CA3AF"; // ç°è‰²èƒŒæ™¯
            buyBtn.style.cursor = "not-allowed"; // ç¦æ­¢æ‰‹åŠ¿
            buyBtn.style.boxShadow = "none";     // å»æ‰é˜´å½±
            buyBtn.href = "javascript:void(0)";  // ç§»é™¤é“¾æ¥
            buyBtn.onclick = (e) => e.preventDefault(); // å½»åº•ç¦æ­¢ç‚¹å‡»

            // 2. é¡¶éƒ¨çš„æ ‡ç­¾ä¹Ÿå˜çº¢æç¤º
            conditionTag.innerText = "â— SOLD OUT";
            conditionTag.style.background = "#FEE2E2"; // æ·¡çº¢è‰²èƒŒæ™¯
            conditionTag.style.color = "#EF4444";      // çº¢è‰²æ–‡å­—
        } else {
            // 3. æ­£å¸¸çŠ¶æ€ (Active)ï¼šä¿æŒåŸæœ‰è´­ä¹°é€»è¾‘
            buyBtn.innerText = "Buy Now";
            buyBtn.href = `Order_Confirmation.html?id=${item.Product_ID}`;

            // æ‹¦æˆªç‚¹å‡»äº‹ä»¶ï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€
            buyBtn.onclick = function(event) {
                event.preventDefault();
                checkLoginAndProceed(this.href);
            };
        }

        // ğŸ”¥ğŸ”¥ğŸ”¥ ã€æ–°å¢ä»£ç ã€‘Chat æŒ‰é’®é€»è¾‘ ï¼ˆå¼ å³»12/22ï¼Œ14:11æ·»åŠ ï¼‰ğŸ”¥ğŸ”¥ğŸ”¥
        const chatBtn = document.querySelector('.chat-btn-small');
        // è·å–å½“å‰ç”¨æˆ·ID (å¼‚æ­¥)
        fetch('../../Module_User_Account_Management/api/session_status.php')
            .then(res => res.json())
            .then(session => {
                if (session.is_logged_in && session.user.user_id == item.User_ID) {
                    // æ˜¯è‡ªå·±çš„å•†å“ï¼Œéšè— Chat æŒ‰é’®
                    chatBtn.style.display = 'none';
                } else {
                    // ä¸æ˜¯è‡ªå·±çš„å•†å“ï¼Œæˆ–è€…æ˜¯æœªç™»å½•
                    chatBtn.onclick = function() {
                        // æ£€æŸ¥ç™»å½•ï¼Œå¦‚æœå·²ç™»å½•åˆ™è·³è½¬åˆ° chat.php (å¸¦ä¸Š contact_id å’Œ product_id)
                        checkLoginAndProceed(`../../Module_User_Account_Management/pages/chat.php?contact_id=${item.User_ID}&product_id=${item.Product_ID}`);
                    };
                }
            });

        // ğŸ”¥ğŸ”¥ å›¾ç‰‡å¤„ç†æ ¸å¿ƒé€»è¾‘ (å¤šå›¾ + ç®­å¤´ + åŠ¨ç”») - Updated to match Source ğŸ”¥ğŸ”¥
        globalImageList = []; // é‡ç½®
        if (item.All_Images) {
            globalImageList = item.All_Images.split(',').map(path => {
                const cleanPath = path.replace(/^.*?Public_Product_Images\//, 'Public_Product_Images/');
                return `../${cleanPath}`;
            });
        } else if (item.Main_Image) {
            const cleanPath = item.Main_Image.replace(/^.*?Public_Product_Images\//, 'Public_Product_Images/');
            globalImageList = [`../${cleanPath}`];
        }

        // å¦‚æœæ²¡æœ‰å›¾ç‰‡
        if (globalImageList.length === 0) {
            document.getElementById('mainImage').innerHTML = '<div style="font-size:5rem;">ğŸ“¦</div>';
            return;
        }

        // æ¸²æŸ“ç¬¬ä¸€å¼ å›¾ç‰‡å’Œæ§ä»¶
        updateMainImageDisplay();
        renderThumbnails();

        // ğŸ”¥æ–°å¢ï¼šä¿å­˜ä¸¾æŠ¥è¦ç”¨åˆ°çš„ä¿¡æ¯
        currentProductForReport = {
            productId: item.Product_ID,
            sellerUserId: item.User_ID,           // seller's user id (reported user)
            sellerUserName: item.User_Username || ''
        };

        // ğŸ”¥æ–°å¢ï¼šæ›´æ–° Report æŒ‰é’®é“¾æ¥ï¼ˆå¸¦å‚æ•°ï¼‰
        const reportBtn = document.getElementById('reportBtn');
        if (reportBtn) {
            reportBtn.addEventListener('click', function (e) {
                e.preventDefault();
                goToReportPageFromProduct();
            }, { once: true });
        }
    }

    // ğŸ”¥ æ ¸å¿ƒå‡½æ•°ï¼šæ›´æ–°ä¸»å›¾æ˜¾ç¤º (From Source)
    function updateMainImageDisplay() {
        const mainImgBox = document.getElementById('mainImage');
        mainImgBox.innerHTML = ''; // Clear container

        // 1. åˆ›å»ºå›¾ç‰‡å…ƒç´ 
        const img = document.createElement('img');
        img.src = globalImageList[currentImageIndex];
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'contain';
        img.className = 'fade-anim'; // æ·»åŠ æ·¡å…¥åŠ¨ç”»ç±»
        mainImgBox.appendChild(img);

        // 2. å¦‚æœæœ‰å¤šå¼ å›¾ï¼Œæ·»åŠ ç®­å¤´
        if (globalImageList.length > 1) {
            const prevBtn = document.createElement('button');
            prevBtn.className = 'nav-arrow prev-btn';
            prevBtn.innerHTML = 'â®';
            prevBtn.onclick = () => changeImage(-1); // ä¸Šä¸€å¼ 

            const nextBtn = document.createElement('button');
            nextBtn.className = 'nav-arrow next-btn';
            nextBtn.innerHTML = 'â¯';
            nextBtn.onclick = () => changeImage(1); // ä¸‹ä¸€å¼ 

            mainImgBox.appendChild(prevBtn);
            mainImgBox.appendChild(nextBtn);
        }

        // 3. æ›´æ–°ç¼©ç•¥å›¾é«˜äº®
        const thumbs = document.querySelectorAll('.thumb');
        thumbs.forEach((t, idx) => {
            if (idx === currentImageIndex) t.classList.add('active');
            else t.classList.remove('active');
        });
    }

    // ğŸ”¥ æ ¸å¿ƒå‡½æ•°ï¼šæ¸²æŸ“ç¼©ç•¥å›¾ (From Source)
    function renderThumbnails() {
        const thumbContainer = document.querySelector('.thumbnails');
        thumbContainer.innerHTML = '';

        globalImageList.forEach((imgSrc, index) => {
            const thumb = document.createElement('div');
            thumb.className = index === currentImageIndex ? 'thumb active' : 'thumb';
            thumb.innerHTML = `<img src="${imgSrc}">`;

            thumb.onclick = () => {
                currentImageIndex = index;
                updateMainImageDisplay();
            };
            thumbContainer.appendChild(thumb);
        });
    }

    // ğŸ”¥ æ ¸å¿ƒå‡½æ•°ï¼šåˆ‡æ¢ä¸Šä¸€å¼ /ä¸‹ä¸€å¼  (From Source)
    function changeImage(direction) {
        currentImageIndex += direction;

        // å¾ªç¯æ’­æ”¾é€»è¾‘
        if (currentImageIndex < 0) {
            currentImageIndex = globalImageList.length - 1; // åˆ°äº†ç¬¬ä¸€å¼ ï¼Œè·³åˆ°æœ€åä¸€å¼ 
        } else if (currentImageIndex >= globalImageList.length) {
            currentImageIndex = 0; // åˆ°äº†æœ€åä¸€å¼ ï¼Œè·³å›ç¬¬ä¸€å¼ 
        }

        updateMainImageDisplay();
    }

    // ğŸ”¥æ–°å¢ï¼šä»å•†å“è¯¦æƒ…é¡µè·³åˆ°ä¸¾æŠ¥é¡µï¼Œå¹¶è‡ªåŠ¨å¸¦ä¸Šå•†å“ID + å¯¹æ–¹ç”¨æˆ·ID/åç§°
    function goToReportPageFromProduct() {
        if (!currentProductForReport || !currentProductForReport.productId) {
            alert('Product info not loaded yet. Please try again.');
            return;
        }

        const url = new URL('../../Module_Platform_Governance_AI_Services/pages/report.html', window.location.href);
        url.searchParams.set('type', 'product');
        url.searchParams.set('itemId', String(currentProductForReport.productId));

        // Report table requires Reported_User_ID NOT NULL, so pass seller id whenever possible
        if (currentProductForReport.sellerUserId) {
            url.searchParams.set('reportedUserId', String(currentProductForReport.sellerUserId));
        }
        if (currentProductForReport.sellerUserName) {
            url.searchParams.set('reportedUserName', currentProductForReport.sellerUserName);
        }

        window.location.href = url.toString();
    }

    // ğŸ”¥ æ–°å¢ï¼šæ£€æŸ¥æ”¶è—çŠ¶æ€ (ä¿®å¤ç‰ˆ) ğŸ”¥
    async function checkFavoriteStatus() {
        // ä½¿ç”¨å…¨å±€å˜é‡ productId
        if (!productId) return;

        try {
            const response = await fetch('../api/Get_User_Favorites.php');
            const result = await response.json();

            if (result.success && Array.isArray(result.data)) {

                // ğŸ” è°ƒè¯•ä¿¡æ¯ï¼šæŒ‰ F12 çœ‹ Console
                // console.log("å½“å‰å•†å“ID:", productId);
                // console.log("æ”¶è—åˆ—è¡¨:", result.data);

                // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæŠŠä¸¤è¾¹éƒ½è½¬æˆ String å†æ¯”è¾ƒï¼Œé˜²æ­¢ç±»å‹ä¸åŒ¹é… (1 vs "1")
                const isFavorited = result.data.some(item => String(item.Product_ID) === String(productId));

                if (isFavorited) {
                    const btn = document.getElementById('favBtn');
                    if (btn) {
                        btn.classList.add('active'); // æ·»åŠ çº¢è‰²æ ·å¼
                    }
                }
            }
        } catch (error) {
            console.error('æ£€æŸ¥æ”¶è—çŠ¶æ€å‡ºé”™:', error);
        }
    }

    // ğŸ”¥ Fav Logic (å·²æ›¿æ¢ä¸º API äº¤äº’) ğŸ”¥
    async function toggleFav() {
        const btn = document.getElementById('favBtn');

        // è¿™é‡Œçš„ productId æ˜¯ä½ é¡µé¢é¡¶éƒ¨ urlParams è·å–åˆ°çš„å…¨å±€å˜é‡
        if (!productId) return;

        const formData = new FormData();
        formData.append('product_id', productId);

        try {
            const response = await fetch('../api/Toggle_Favorite.php', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                // æ ¹æ®åç«¯è¿”å›çš„åŠ¨ä½œæ›´æ–° UI
                if (result.action === 'added') {
                    btn.classList.add('active');
                    showToast('â¤ï¸ Added to Favorites');
                } else {
                    btn.classList.remove('active');
                    showToast('ğŸ’” Removed from Favorites');
                }
            } else {
                // å¦‚æœå¤±è´¥ï¼ˆä¾‹å¦‚æœªç™»å½•ï¼‰
                if(result.message === 'Please login first') {
                    if(confirm("You need to login to add favorites. Go to login?")) {
                        window.location.href = '../Auth/login.html';
                    }
                } else {
                    showToast('âš ï¸ ' + result.message);
                }
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('âŒ Network Error');
        }
    }

    function showToast(message) {
        var x = document.getElementById("toast");
        x.innerText = message;
        x.className = "toast show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    // ğŸ”¥ æ–°å¢ï¼šè´­ä¹°å‰æ£€æŸ¥ç™»å½•çŠ¶æ€ ğŸ”¥
    async function checkLoginAndProceed(targetUrl) {
        try {
            const response = await fetch('../api/Session_Status.php');
            const result = await response.json();

            if (result.is_logged_in) {
                window.location.href = targetUrl;
            } else {
                // æœªç™»å½•ï¼Œæ˜¾ç¤ºå…¨å±€ç™»å½•å¼¹çª—
                if (typeof AuthModal !== 'undefined') {
                    AuthModal.show();
                } else {
                    // é™çº§å¤„ç†ï¼šå¦‚æœ AuthModal æœªåŠ è½½
                    if(confirm("Please login to continue. Go to login page?")) {
                        window.location.href = '../../Module_User_Account_Management/pages/login.php';
                    }
                }
            }
        } catch (error) {
            console.error('Session check failed:', error);
            // ç½‘ç»œé”™è¯¯ç­‰æƒ…å†µï¼Œå®‰å…¨èµ·è§æç¤ºç”¨æˆ·
            alert("Network error. Please check your connection.");
        }
    }
</script>
<script src="../../Public_Assets/js/auth_modal.js"></script>
</body>
</html>