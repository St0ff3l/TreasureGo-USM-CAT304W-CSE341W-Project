<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Detail - TreasureGO</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- 1. Global Styles --- */
        :root {
            --bg-color: #F3F6F9;
            --primary: #4F46E5;
            --primary-hover: #4338CA;
            --text-dark: #1F2937;
            --text-gray: #6B7280;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
            --success: #10B981;
            --warning: #F59E0B;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-dark);
            min-height: 100vh;
            padding-bottom: 50px;
        }

        /* --- 2. Navbar & Layout --- */
        /* Note: Navbar styles are handled by headerbar.js generally, but keeping layout basics */
        .breadcrumb { max-width: 1100px; margin: 20px auto; padding: 0 20px; font-size: 0.9rem; color: var(--text-gray); }
        .breadcrumb a { text-decoration: none; color: var(--text-gray); }

        .product-container { max-width: 1100px; margin: 0 auto; padding: 0 20px; display: grid; grid-template-columns: 1.2fr 1fr; gap: 50px; align-items: start; }

        /* --- 3. Gallery Styles --- */
        .gallery-wrapper { position: sticky; top: 100px; }

        .main-image-box {
            width: 100%; height: 500px; background: white; border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 8rem; box-shadow: var(--card-shadow); margin-bottom: 15px;
            position: relative; overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .nav-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 44px; height: 44px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%; border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; color: var(--text-dark); z-index: 10;
            transition: all 0.2s ease;
            opacity: 0; /* Hidden by default */
        }
        .main-image-box:hover .nav-arrow { opacity: 1; }
        .nav-arrow:hover { background: var(--primary); color: white; transform: translateY(-50%) scale(1.1); }

        .prev-btn { left: 15px; }
        .next-btn { right: 15px; }

        .fade-anim { animation: fadeScale 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes fadeScale {
            from { opacity: 0.6; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šç¼©ç•¥å›¾é€‰ä¸­æ ·å¼ä¼˜åŒ– ğŸ”¥ğŸ”¥ğŸ”¥ */
        .thumbnails {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            /* å¢åŠ å†…è¾¹è·ï¼Œé˜²æ­¢å…‰åœˆè¢«åˆ‡ */
            padding: 10px 5px;
        }
        .thumb {
            width: 80px; height: 80px;
            background: white;
            border-radius: 14px;
            cursor: pointer;
            flex-shrink: 0;
            overflow: hidden;
            /* é»˜è®¤åŠé€æ˜ä¸”ç¨å¾®ç¼©å° */
            opacity: 0.6;
            transform: scale(0.95);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* å¼¹æ€§åŠ¨ç”» */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .thumb img {
            width: 100%; height: 100%;
            object-fit: cover;
        }
        .thumb:hover {
            opacity: 0.8;
        }
        .thumb.active {
            opacity: 1;
            /* é€‰ä¸­æ—¶ï¼šæ¢å¤åŸå¤§å¹¶ç¨å¾®æ”¾å¤§ï¼ŒåŠ ä¸Šä¸»è‰²å…‰åœˆæŠ•å½± */
            transform: scale(1.05);
            box-shadow: 0 0 0 3px var(--primary), 0 5px 15px rgba(79, 70, 229, 0.3);
        }
        /* ğŸ”¥ğŸ”¥ğŸ”¥ ä¿®æ”¹ç»“æŸ ğŸ”¥ğŸ”¥ğŸ”¥ */

        /* --- 4. Product Info & Report --- */
        .product-info { padding-top: 10px; }

        .tag-report-wrapper {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; margin-bottom: 15px;
        }

        .product-tag {
            display: inline-block; background: #DEF7EC; color: var(--success);
            padding: 6px 12px; border-radius: 50px; font-size: 0.85rem; font-weight: 600;
        }

        .report-inline-btn {
            height: 36px; padding: 0 12px; background: white;
            border: 1px solid #E5E7EB; border-radius: 30px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            text-decoration: none; color: #9CA3AF; transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .report-text { font-size: 0.9rem; font-weight: 600; }
        .report-icon { font-size: 1.1rem; }
        .report-inline-btn:hover {
            color: #EF4444; border-color: #EF4444;
            transform: translateY(-2px); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);
        }

        .product-title { font-size: 2.2rem; font-weight: 800; line-height: 1.2; margin-bottom: 10px; }
        .product-price { font-size: 2rem; color: var(--primary); font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }

        .delivery-badges { display: flex; gap: 10px; margin-bottom: 30px; }
        .badge { padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .badge-meet { background: #ECFDF5; color: #059669; }
        .badge-ship { background: #EEF2FF; color: #4F46E5; }

        /* --- 5. Seller & Location --- */
        .seller-card {
            background: white; padding: 20px; border-radius: 20px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 25px;
            border: 1px solid rgba(0,0,0,0.03);
        }
        .seller-info { display: flex; align-items: center; gap: 15px; }
        .seller-avatar { width: 50px; height: 50px; background: #ddd; border-radius: 50%; font-size: 25px; display: flex; align-items: center; justify-content: center; }

        .chat-btn-small {
            background: #f0f0f0; color: var(--text-dark); border: none;
            padding: 8px 16px; border-radius: 12px; font-weight: 600;
            cursor: pointer; transition: 0.2s;
        }
        .chat-btn-small:hover { background: #e5e7eb; }

        .location-box { display: flex; align-items: center; gap: 12px; background: #f9f9fb; padding: 14px 16px; border-radius: 16px; margin-bottom: 30px; border: 1px solid #eee; color: var(--text-dark); font-size: 0.95rem; font-weight: 500; }
        .description-text { color: var(--text-gray); line-height: 1.7; font-size: 1rem; margin-bottom: 40px; }

        /* --- 6. Actions --- */
        .action-buttons { display: flex; gap: 15px; margin-top: 20px; }
        .btn-buy {
            flex: 1; background: var(--primary); color: white; border: none;
            padding: 18px; border-radius: 16px; font-size: 1.1rem; font-weight: 700;
            cursor: pointer; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
            transition: 0.2s; text-align: center; text-decoration: none;
        }
        .btn-buy:hover { background: var(--primary-hover); transform: translateY(-2px); }

        .btn-fav { width: 60px; background: white; border: 2px solid #eee; border-radius: 16px; font-size: 1.5rem; cursor: pointer; color: #ccc; transition: 0.2s; }
        .btn-fav.active { background: #fef2f2; border-color: #ef4444; color: #ef4444; }

        .safety-box { margin-top: 30px; background: #EFF6FF; border-radius: 16px; padding: 20px; color: #1E40AF; font-size: 0.9rem; display: flex; gap: 10px; align-items: center; }

        /* --- 7. Toast --- */
        .toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 10000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        .toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        @media (max-width: 768px) {
            .product-container { grid-template-columns: 1fr; gap: 30px; }
            .gallery-wrapper { position: static; }
            .main-image-box { height: 350px; }
            .product-title { font-size: 1.8rem; }
            .nav-arrow { opacity: 1; width: 36px; height: 36px; }
        }
    </style>
</head>
<body>

<script src="../../Public_Assets/js/headerbar.js"></script>
<script src="../../Public_Assets/js/auth_modal.js"></script>

<script>
    // ç»Ÿä¸€æŒ‚è½½ Headerbar
    TreasureGoHeaderbar.mount({ basePath: '../../' });
</script>

<div class="breadcrumb">
    <a href="../../index.html">Home</a> &gt; <span>Digital</span> &gt; <span>Product Detail</span>
</div>

<div class="product-container">
    <div class="gallery-wrapper">
        <div class="main-image-box" id="mainImage">
            <div style="font-size:5rem;">ğŸ“¦</div>
        </div>
        <div class="thumbnails">
        </div>
    </div>

    <div class="product-info">
        <div class="tag-report-wrapper">
            <div class="product-tag">Condition: Loading...</div>
            <a href="javascript:void(0)" class="report-inline-btn" id="reportBtn" title="Report this item">
                <span class="report-text">Report</span>
                <span class="report-icon">ğŸ´</span>
            </a>
        </div>

        <h1 class="product-title">Loading Product...</h1>
        <div class="product-price">RM0.00</div>

        <div class="delivery-badges">
            Loading Options...
        </div>

        <div class="seller-card">
            <div class="seller-info">
                <div class="seller-avatar">ğŸ‘¤</div>
                <div class="seller-details">
                    <h4>Loading...</h4>
                    <div class="seller-rating">...</div>
                </div>
            </div>
            <button class="chat-btn-small" onclick="showToast('ğŸ’¬ Checking status...')">Chat</button>
        </div>

        <div class="location-box">
            <span style="font-size: 1.3rem;">ğŸ“</span>
            <div><span style="display:block; color:#666; font-size:0.85rem;">Seller Location:</span><strong>Loading...</strong></div>
        </div>

        <h3 class="section-title">Description</h3>
        <p class="description-text">
            Loading description...
        </p>

        <div class="action-buttons">
            <button class="btn-fav" id="favBtn" onclick="toggleFav()">â™¥</button>
            <a href="#" class="btn-buy">Buy Now</a>
        </div>

        <div class="safety-box">
            <span style="font-size: 1.5rem;">ğŸ›¡ï¸</span>
            <div><strong>Treasure Safety Tip:</strong><br>For meet-ups, please choose a safe public location.</div>
        </div>
    </div>
</div>

<div id="toast" class="toast">Action Successful</div>

<script>
    // --- 1. å…¨å±€å˜é‡ ---
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');

    // å›¾ç‰‡ç”»å»Šå˜é‡
    let globalImageList = [];
    let currentImageIndex = 0;

    // Report æ•°æ®ç¼“å­˜
    let currentProductForReport = null;

    // --- 2. åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        if (!productId) {
            alert("Product not found!");
            window.location.href = '../../index.html';
            return;
        }

        // åŠ è½½è¯¦æƒ… & æ£€æŸ¥æ”¶è— (å¹¶è¡Œ)
        loadProductDetails(productId);
        checkFavoriteStatus();
    });

    // --- 3. æ ¸å¿ƒåŠ è½½é€»è¾‘ ---
    async function loadProductDetails(id) {
        try {
            const response = await fetch(`../api/Get_Products.php?product_id=${id}`);
            const result = await response.json();

            if (result.success && result.data.length > 0) {
                const product = result.data[0];
                renderProduct(product);
            } else {
                alert("Product details not found.");
            }
        } catch (error) {
            console.error("Error loading product:", error);
        }
    }

    // --- 4. æ¸²æŸ“é¡µé¢ ---
    function renderProduct(item) {
        // A. åŸºç¡€æ–‡æœ¬
        document.querySelector('.product-title').innerText = item.Product_Title;
        document.querySelector('.product-price').innerHTML = `RM${parseFloat(item.Product_Price).toFixed(2)}`;
        document.querySelector('.description-text').innerText = item.Product_Description || "No description available.";
        document.querySelector('.seller-details h4').innerText = item.User_Username;
        const rating = item.User_Average_Rating ? `â˜… ${item.User_Average_Rating}` : 'New Seller';
        document.querySelector('.seller-rating').innerText = rating;

        const location = item.Product_Location || 'Unknown Location';
        document.querySelector('.location-box div strong').innerText = location;

        const conditionTag = document.querySelector('.product-tag');
        conditionTag.innerText = `Condition: ${item.Product_Condition}`;

        // B. åŠ¨æ€æ¸²æŸ“äº¤æ˜“æ–¹å¼æ ‡ç­¾ (Badges)
        const badgesContainer = document.querySelector('.delivery-badges');
        badgesContainer.innerHTML = '';
        const method = item.Delivery_Method;
        if (method === 'meetup' || method === 'both') {
            badgesContainer.innerHTML += `<span class="badge badge-meet">ğŸ¤ Meet-up Available</span>`;
        }
        if (method === 'shipping' || method === 'both') {
            badgesContainer.innerHTML += `<span class="badge badge-ship">ğŸšš Shipping Available</span>`;
        }

        // C. æŒ‰é’®çŠ¶æ€é€»è¾‘ (Sold vs Active)
        const buyBtn = document.querySelector('.btn-buy');
        if (item.Product_Status === 'Sold' || item.Product_Status === 'Inactive') {
            // å·²å”®å‡º
            buyBtn.innerText = "Sold Out";
            buyBtn.style.background = "#9CA3AF";
            buyBtn.style.cursor = "not-allowed";
            buyBtn.style.boxShadow = "none";
            buyBtn.href = "javascript:void(0)";
            buyBtn.onclick = (e) => e.preventDefault();

            conditionTag.innerText = "â— SOLD OUT";
            conditionTag.style.background = "#FEE2E2";
            conditionTag.style.color = "#EF4444";
        } else {
            // æ­£å¸¸çŠ¶æ€
            buyBtn.innerText = "Buy Now";
            buyBtn.href = `Order_Confirmation.html?id=${item.Product_ID}`;
            buyBtn.onclick = function(event) {
                event.preventDefault();
                checkLoginAndProceed(this.href);
            };
        }

        // D. ä¸¾æŠ¥æŒ‰é’®é“¾æ¥ç”Ÿæˆ (Report)
        currentProductForReport = {
            productId: item.Product_ID,
            sellerUserId: item.User_ID,
            sellerUserName: item.User_Username || ''
        };
        const reportUrl = buildReportSubmitUrlForProduct();
        const reportBtn = document.getElementById('reportBtn');
        if(reportBtn && reportUrl) {
            reportBtn.href = reportUrl;
        }

        // E. èŠå¤©æŒ‰é’®é€»è¾‘ (Chat) - æ£€æŸ¥æ˜¯å¦ä¸ºæœ¬äºº
        setupChatButton(item);

        // F. å›¾ç‰‡å¤„ç†
        handleImages(item);
    }

    // --- 5. è¾…åŠ©åŠŸèƒ½é€»è¾‘ ---

    // 5.1 Chat Button Setup
    function setupChatButton(item) {
        const chatBtn = document.querySelector('.chat-btn-small');

        // æ£€æŸ¥ Session (ä½¿ç”¨ç»Ÿä¸€çš„ Session API)
        fetch('../../Module_User_Account_Management/api/session_status.php')
            .then(res => res.json())
            .then(session => {
                // å¦‚æœå·²ç™»å½• ä¸” å½“å‰ç”¨æˆ·æ˜¯å–å®¶ -> éšè—æŒ‰é’®
                if (session.is_logged_in && String(session.user.user_id) === String(item.User_ID)) {
                    chatBtn.style.display = 'none';
                } else {
                    // å¦åˆ™ç»‘å®šç‚¹å‡»äº‹ä»¶
                    chatBtn.style.display = 'block';
                    chatBtn.onclick = function() {
                        // æ£€æŸ¥ç™»å½•åè·³è½¬èŠå¤©é¡µ
                        const chatUrl = `../../Module_User_Account_Management/pages/chat.php?contact_id=${item.User_ID}&product_id=${item.Product_ID}`;
                        checkLoginAndProceed(chatUrl);
                    };
                }
            })
            .catch(err => console.error("Session Check Error:", err));
    }

    // 5.2 Build Report URL
    function buildReportSubmitUrlForProduct() {
        if (!currentProductForReport || !currentProductForReport.productId) return null;

        const baseUrl = '../../Module_Platform_Governance_AI_Services/pages/report_submit.html';
        const params = new URLSearchParams();
        params.set('itemId', String(currentProductForReport.productId));
        if (currentProductForReport.sellerUserId) {
            params.set('reportedUserId', String(currentProductForReport.sellerUserId));
        }
        if (currentProductForReport.sellerUserName) {
            params.set('reportedUserName', String(currentProductForReport.sellerUserName));
        }
        params.set('type', 'product');

        return `${baseUrl}?${params.toString()}`;
    }

    // 5.3 Image Gallery Logic
    function handleImages(item) {
        globalImageList = [];

        // è§£æå›¾ç‰‡è·¯å¾„ - ä¿®å¤äº†è·¯å¾„æ‹¼æ¥é—®é¢˜ (../ -> ../../)
        if (item.All_Images) {
            globalImageList = item.All_Images.split(',').map(path => {
                // 1. æ ‡å‡†åŒ–æ–œæ ï¼Œé˜²æ­¢ Windows è·¯å¾„é”™è¯¯
                let cleanPath = path.replace(/\\/g, '/');
                // 2. æˆªå– Public_Images ä¹‹åçš„éƒ¨åˆ†
                cleanPath = cleanPath.replace(/^.*?Public_Images\//, 'Public_Images/');
                // 3. ä½¿ç”¨æ­£ç¡®çš„ ../../ å±‚çº§
                return `../../${cleanPath}`;
            });
        } else if (item.Main_Image) {
            let cleanPath = item.Main_Image.replace(/\\/g, '/');
            cleanPath = cleanPath.replace(/^.*?Public_Images\//, 'Public_Images/');
            globalImageList = [`../../${cleanPath}`];
        }

        if (globalImageList.length === 0) {
            document.getElementById('mainImage').innerHTML = '<div style="font-size:5rem;">ğŸ“¦</div>';
            return;
        }

        updateMainImageDisplay();
        renderThumbnails();
    }

    function updateMainImageDisplay() {
        const mainImgBox = document.getElementById('mainImage');
        mainImgBox.innerHTML = '';

        // Main Image
        const img = document.createElement('img');
        img.src = globalImageList[currentImageIndex];
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'contain';
        img.className = 'fade-anim';
        mainImgBox.appendChild(img);

        // Arrows
        if (globalImageList.length > 1) {
            const prevBtn = document.createElement('button');
            prevBtn.className = 'nav-arrow prev-btn';
            prevBtn.innerHTML = 'â®';
            prevBtn.onclick = () => changeImage(-1);

            const nextBtn = document.createElement('button');
            nextBtn.className = 'nav-arrow next-btn';
            nextBtn.innerHTML = 'â¯';
            nextBtn.onclick = () => changeImage(1);

            mainImgBox.appendChild(prevBtn);
            mainImgBox.appendChild(nextBtn);
        }

        // Highlight Active Thumb
        const thumbs = document.querySelectorAll('.thumb');
        thumbs.forEach((t, idx) => {
            if (idx === currentImageIndex) t.classList.add('active');
            else t.classList.remove('active');
        });
    }

    function renderThumbnails() {
        const thumbContainer = document.querySelector('.thumbnails');
        thumbContainer.innerHTML = '';
        globalImageList.forEach((imgSrc, index) => {
            const thumb = document.createElement('div');
            thumb.className = index === currentImageIndex ? 'thumb active' : 'thumb';
            thumb.innerHTML = `<img src="${imgSrc}">`;
            thumb.onclick = () => {
                currentImageIndex = index;
                updateMainImageDisplay();
            };
            thumbContainer.appendChild(thumb);
        });
    }

    function changeImage(direction) {
        currentImageIndex += direction;
        if (currentImageIndex < 0) currentImageIndex = globalImageList.length - 1;
        else if (currentImageIndex >= globalImageList.length) currentImageIndex = 0;
        updateMainImageDisplay();
    }

    // 5.4 Favorites Logic
    async function checkFavoriteStatus() {
        if (!productId) return;
        try {
            const response = await fetch('../api/Get_User_Favorites.php');
            const result = await response.json();
            if (result.success && Array.isArray(result.data)) {
                // String comparison to be safe
                const isFavorited = result.data.some(item => String(item.Product_ID) === String(productId));
                if (isFavorited) {
                    document.getElementById('favBtn').classList.add('active');
                }
            }
        } catch (error) {
            console.error('Check Fav Error:', error);
        }
    }

    async function toggleFav() {
        if (!productId) return;
        const btn = document.getElementById('favBtn');
        const formData = new FormData();
        formData.append('product_id', productId);

        try {
            const response = await fetch('../api/Toggle_Favorite.php', { method: 'POST', body: formData });
            const result = await response.json();

            if (result.success) {
                if (result.action === 'added') {
                    btn.classList.add('active');
                    showToast('â¤ï¸ Added to Favorites');
                } else {
                    btn.classList.remove('active');
                    showToast('ğŸ’” Removed from Favorites');
                }
            } else {
                if(result.message === 'Please login first') {
                    if (typeof AuthModal !== 'undefined' && AuthModal.show) {
                        AuthModal.show();
                    } else if(confirm("Login required. Go to login?")) {
                        window.location.href = '../../Module_User_Account_Management/pages/login.php';
                    }
                } else {
                    showToast('âš ï¸ ' + result.message);
                }
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('âŒ Network Error');
        }
    }

    // 5.5 Check Login Middleware
    async function checkLoginAndProceed(targetUrl) {
        try {
            // ä½¿ç”¨ç»Ÿä¸€çš„ session æ£€æŸ¥ç‚¹
            const response = await fetch('../../Module_User_Account_Management/api/session_status.php');
            const result = await response.json();

            if (result.is_logged_in) {
                window.location.href = targetUrl;
            } else {
                if (typeof AuthModal !== 'undefined' && AuthModal.show) {
                    AuthModal.show();
                } else if (confirm("Please login to continue. Go to login page?")) {
                    window.location.href = '../../Module_User_Account_Management/pages/login.php';
                }
            }
        } catch (error) {
            console.error('Session check failed:', error);
            alert("Network error. Please check your connection.");
        }
    }

    function showToast(message) {
        var x = document.getElementById("toast");
        x.innerText = message;
        x.className = "toast show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }
</script>

</body>
</html>

