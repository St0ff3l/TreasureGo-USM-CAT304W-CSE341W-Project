<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Detail - TreasureGO</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- 1. Global Styles --- */
        :root {
            --bg-color: #F3F6F9;
            --primary: #4F46E5;
            --primary-hover: #4338CA;
            --text-dark: #1F2937;
            --text-gray: #6B7280;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
            --success: #10B981;
            --warning: #F59E0B;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-dark);
            min-height: 100vh;
            padding-bottom: 50px;
        }

        /* --- 2. Navbar --- */
        .navbar {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.5);
        }

        .logo { font-weight: 800; font-size: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 10px; text-decoration: none; }
        .logo span { color: var(--text-dark); }
        .logo-img { width: 42px; height: 42px; border-radius: 10px; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .nav-actions { display: flex; align-items: center; gap: 20px; }
        .nav-btn { border: none; background: transparent; font-weight: 600; color: var(--text-gray); padding: 0.6rem 0.5rem; cursor: pointer; transition: color 0.2s; font-size: 1rem; }
        .nav-btn:hover { color: var(--text-dark); }

        .btn-primary { border: none; background-color: var(--text-dark); color: white; font-weight: 600; padding: 0.7rem 1.8rem; border-radius: 12px; cursor: pointer; transition: all 0.2s; font-size: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary:hover { transform: translateY(-2px); background-color: #000; }

        .menu-container { position: relative; display: inline-block; }
        .dots-btn { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; color: var(--text-dark); font-weight: bold; padding-bottom: 6px; transition: 0.2s; }
        .dots-btn:hover { background: #eee; }
        .dropdown-content { display: none; position: absolute; right: 0; top: 130%; background-color: white; min-width: 160px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); border-radius: 16px; z-index: 1001; padding: 8px; }
        .menu-container:hover .dropdown-content { display: block; }
        .dropdown-item { color: var(--text-dark); padding: 12px 16px; text-decoration: none; display: block; font-size: 14px; font-weight: 500; border-radius: 10px; }
        .dropdown-item:hover { background-color: #f3f4f6; color: var(--primary); }

        /* --- 3. Breadcrumb & Layout --- */
        .breadcrumb { max-width: 1100px; margin: 20px auto; padding: 0 20px; font-size: 0.9rem; color: var(--text-gray); }
        .breadcrumb a { text-decoration: none; color: var(--text-gray); }

        .product-container { max-width: 1100px; margin: 0 auto; padding: 0 20px; display: grid; grid-template-columns: 1.2fr 1fr; gap: 50px; align-items: start; }

        /* --- Gallery Styles (å·²ä¼˜åŒ–) --- */
        .gallery-wrapper { position: sticky; top: 100px; }

        .main-image-box {
            width: 100%;
            height: 500px;
            background: #f3f4f6; /* âœ… æ”¹ä¸ºæµ…ç°è‰²èƒŒæ™¯ */
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            border: 1px solid rgba(0,0,0,0.05);
            overflow: hidden; /* âœ… é˜²æ­¢å›¾ç‰‡æº¢å‡ºåœ†è§’ */
            position: relative;
        }
        /* ğŸ”¥ æ–°å¢ï¼šå·¦å³åˆ‡æ¢ç®­å¤´çš„æ ·å¼ ğŸ”¥ */
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%); /* å‚ç›´å±…ä¸­ */
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.9); /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ */
            border-radius: 50%; /* åœ†å½¢ */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-dark);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 10; /* ä¿è¯åœ¨å›¾ç‰‡ä¸Šé¢ */
            opacity: 0; /* é»˜è®¤éšè— */
            transition: all 0.3s ease;
            border: none; /* ç§»é™¤æŒ‰é’®é»˜è®¤è¾¹æ¡† */
            outline: none;
        }

        /* é¼ æ ‡æ‚¬åœåœ¨ä¸»å›¾åŒºåŸŸæ—¶ï¼Œæ˜¾ç¤ºç®­å¤´ */
        .main-image-box:hover .nav-arrow {
            opacity: 1;
        }

        .nav-arrow:hover {
            background: white;
            color: var(--primary);
            box-shadow: 0 6px 15px rgba(79, 70, 229, 0.3);
        }

        .arrow-prev { left: 15px; padding-right: 3px; } /* å·¦ç®­å¤´ä½ç½®ï¼Œå¾®è°ƒpaddingè®©å›¾æ ‡è§†è§‰å±…ä¸­ */
        .arrow-next { right: 15px; padding-left: 3px; } /* å³ç®­å¤´ä½ç½® */

        /* (ä»¥ä¸‹æ˜¯åŸæœ‰çš„ç¼©ç•¥å›¾æ ·å¼ï¼Œä¿æŒä¸å˜) */
        .thumbnails { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px; }

        .thumb {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.2s;
            flex-shrink: 0; /* âœ… é˜²æ­¢ç¼©ç•¥å›¾è¢«æŒ¤å‹ */
            overflow: hidden; /* âœ… ç¡®ä¿ç¼©ç•¥å›¾å¡«å…… */
        }

        .thumb.active { border-color: var(--primary); transform: translateY(-2px); }

        /* Info */
        .product-info { padding-top: 10px; }

        .tag-report-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 15px;
        }

        .product-tag {
            display: inline-block;
            background: #DEF7EC;
            color: var(--success);
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .report-inline-btn {
            height: 36px;
            padding: 0 12px;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            color: #9CA3AF;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .report-text { font-size: 0.9rem; font-weight: 600; }
        .report-icon { font-size: 1.1rem; }

        .report-inline-btn:hover {
            color: #EF4444;
            border-color: #EF4444;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);
        }

        .product-title { font-size: 2.2rem; font-weight: 800; line-height: 1.2; margin-bottom: 10px; }
        .product-price { font-size: 2rem; color: var(--primary); font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .original-price { font-size: 1.2rem; color: #ccc; text-decoration: line-through; font-weight: 400; }

        /* Badges */
        .delivery-badges { display: flex; gap: 10px; margin-bottom: 30px; }
        .badge { padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .badge-meet { background: #ECFDF5; color: #059669; }
        .badge-ship { background: #EEF2FF; color: #4F46E5; }

        /* Seller & Location */
        .seller-card { background: white; padding: 20px; border-radius: 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 25px; border: 1px solid rgba(0,0,0,0.03); }
        .seller-info { display: flex; align-items: center; gap: 15px; }
        .seller-avatar { width: 50px; height: 50px; background: #ddd; border-radius: 50%; font-size: 25px; display: flex; align-items: center; justify-content: center; }
        .chat-btn-small { background: #f0f0f0; color: var(--text-dark); border: none; padding: 8px 16px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; }

        .location-box { display: flex; align-items: center; gap: 12px; background: #f9f9fb; padding: 14px 16px; border-radius: 16px; margin-bottom: 30px; border: 1px solid #eee; color: var(--text-dark); font-size: 0.95rem; font-weight: 500; }

        .description-text { color: var(--text-gray); line-height: 1.7; font-size: 1rem; margin-bottom: 40px; }

        /* Actions */
        .action-buttons { display: flex; gap: 15px; margin-top: 20px; }
        .btn-buy { flex: 1; background: var(--primary); color: white; border: none; padding: 18px; border-radius: 16px; font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3); transition: 0.2s; text-align: center; text-decoration: none; }
        .btn-buy:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn-fav { width: 60px; background: white; border: 2px solid #eee; border-radius: 16px; font-size: 1.5rem; cursor: pointer; color: #ccc; transition: 0.2s; }
        .btn-fav.active { background: #fef2f2; border-color: #ef4444; color: #ef4444; }

        .safety-box { margin-top: 30px; background: #EFF6FF; border-radius: 16px; padding: 20px; color: #1E40AF; font-size: 0.9rem; display: flex; gap: 10px; align-items: center; }

        /* Toast */
        .toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 10000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        .toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        @media (max-width: 768px) {
            .product-container { grid-template-columns: 1fr; gap: 30px; }
            .gallery-wrapper { position: static; }
            .main-image-box { height: 350px; }
            .product-title { font-size: 1.8rem; }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="../../index.html" class="logo">
        <img src="../../Public_Assets/images/TreasureGo_Logo.png" alt="Logo" class="logo-img">
        Treasure<span>Go</span>
    </a>
    <div class="nav-actions">
        <button class="nav-btn" onclick="alert('Top Up Page')">Top Up</button>
        <button class="nav-btn">Orders</button>
        <button class="btn-primary">Login</button>
        <div class="menu-container">
            <div class="dots-btn">â€¢â€¢â€¢</div>
            <div class="dropdown-content">
                <a href="#" class="dropdown-item">Settings</a>
                <a href="#" class="dropdown-item" style="color: #ef4444;">Log Out</a>
            </div>
        </div>
    </div>
</nav>

<div class="breadcrumb">
    <a href="../../index.html">Home</a> &gt; <span>Digital</span> &gt; <span>Sony Headphones</span>
</div>

<div class="product-container">
    <div class="gallery-wrapper">
        <div class="main-image-box" id="mainImage">ğŸ§</div>
        <div class="thumbnails">
            <div class="thumb active">ğŸ§</div>
        </div>
    </div>

    <div class="product-info">
        <div class="tag-report-wrapper">
            <div class="product-tag">Condition: Loading...</div>
            <a href="../../Module_Platform_Governance_AI_Services/pages/report.html" class="report-inline-btn" id="reportBtn" title="Report this item">
                <span class="report-text">Report</span>
                <span class="report-icon">ğŸ´</span>
            </a>
        </div>

        <h1 class="product-title">Loading Product...</h1>
        <div class="product-price">$0.00</div>

        <div class="delivery-badges">
            <span class="badge badge-meet">ğŸ¤ Meet-up Available</span>
            <span class="badge badge-ship">ğŸšš Shipping Available</span>
        </div>

        <div class="seller-card">
            <div class="seller-info">
                <div class="seller-avatar">ğŸ‘¤</div>
                <div class="seller-details">
                    <h4>Loading...</h4>
                    <div class="seller-rating">...</div>
                </div>
            </div>
            <button class="chat-btn-small" onclick="showToast('ğŸ’¬ Opening Chat...')">Chat</button>
        </div>

        <div class="location-box">
            <span style="font-size: 1.3rem;">ğŸ“</span>
            <div><span style="display:block; color:#666; font-size:0.85rem;">Seller Location:</span><strong>Loading...</strong></div>
        </div>

        <h3 class="section-title">Description</h3>
        <p class="description-text">
            Loading description...
        </p>

        <div class="action-buttons">
            <button class="btn-fav" id="favBtn" onclick="toggleFav()">â™¥</button>
            <a href="Order_Confirmation.html" class="btn-buy">Buy Now</a>
        </div>

        <div class="safety-box">
            <span style="font-size: 1.5rem;">ğŸ›¡ï¸</span>
            <div><strong>Treasure Safety Tip:</strong><br>For meet-ups, please choose a safe public location.</div>
        </div>
    </div>
</div>

<div id="toast" class="toast">Action Successful</div>

<script>
    // 1. è·å– URL ä¸­çš„å•†å“ ID
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');

    // ğŸ”¥æ–°å¢ï¼šä¿å­˜å½“å‰å•†å“ä¿¡æ¯ï¼Œç»™ Report è·³è½¬ç”¨
    let currentProductForReport = null;

    // 2. åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        if (!productId) {
            alert("Product not found!");
            window.location.href = '../../index.html';
            return;
        }

        // åŠ è½½è¯¦æƒ…
        loadProductDetails(productId);

        // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šåŠ è½½æ”¶è—çŠ¶æ€ ğŸ”¥
        checkFavoriteStatus();
    });

    // 3. åŠ è½½å•†å“è¯¦æƒ…
    async function loadProductDetails(id) {
        try {
            const response = await fetch(`../api/Get_Products.php?product_id=${id}`);
            const result = await response.json();

            if (result.success && result.data.length > 0) {
                const product = result.data[0];
                renderProduct(product);
            } else {
                alert("Product details not found.");
            }
        } catch (error) {
            console.error("Error loading product:", error);
        }
    }

    // 4. æ¸²æŸ“é¡µé¢
    function renderProduct(item) {
        // --- åŸºç¡€ä¿¡æ¯æ¸²æŸ“ (ä¿æŒä¸å˜) ---
        document.querySelector('.product-title').innerText = item.Product_Title;
        document.querySelector('.product-price').innerHTML = `$${parseFloat(item.Product_Price).toFixed(2)}`;
        item.Product_Description ? document.querySelector('.description-text').innerText = item.Product_Description : document.querySelector('.description-text').innerText = "No description available.";
        document.querySelector('.product-tag').innerText = `Condition: ${item.Product_Condition}`;
        const location = item.Product_Location || 'Unknown Location';
        document.querySelector('.location-box div strong').innerText = location;
        document.querySelector('.seller-details h4').innerText = item.User_Username;
        const rating = item.User_Average_Rating ? `â˜… ${item.User_Average_Rating}` : 'New Seller';
        document.querySelector('.seller-rating').innerText = rating;

        // ğŸ”¥ğŸ”¥ğŸ”¥ ã€æ–°å¢ä»£ç ã€‘æ›´æ–° Buy Now æŒ‰é’®çš„è·³è½¬é“¾æ¥ï¼Œå¸¦ä¸Š ID ğŸ”¥ğŸ”¥ğŸ”¥
        const buyBtn = document.querySelector('.btn-buy');
        buyBtn.href = `Order_Confirmation.html?id=${item.Product_ID}`;
        
        // æ‹¦æˆªç‚¹å‡»äº‹ä»¶ï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€
        buyBtn.onclick = function(event) {
            event.preventDefault();
            checkLoginAndProceed(this.href);
        };

        // ============================================
        // ğŸ”¥ å›¾ç‰‡å¤„ç†é€»è¾‘ (Gallery Logic) - æ”¯æŒå·¦å³åˆ‡æ¢ ğŸ”¥
        // ============================================
        const mainImgBox = document.getElementById('mainImage');
        const thumbContainer = document.querySelector('.thumbnails');

        // æ¸…ç©ºæ—§å†…å®¹
        mainImgBox.innerHTML = '';
        thumbContainer.innerHTML = '';

        // å‡†å¤‡å›¾ç‰‡åˆ—è¡¨
        globalImageList = []; // é‡ç½®å…¨å±€åˆ—è¡¨
        if (item.All_Images) {
            globalImageList = item.All_Images.split(',');
        } else if (item.Main_Image) {
            globalImageList = [item.Main_Image];
        }

        if (globalImageList.length > 0) {
            // 1. æ¸²æŸ“ç¼©ç•¥å›¾å’Œåˆå§‹ä¸»å›¾
            globalImageList.forEach((imgRawPath, index) => {
                const cleanPath = imgRawPath.replace(/^.*?Public_Product_Images\//, 'Public_Product_Images/');
                const fullPath = `../${cleanPath}`;

                // åˆ›å»ºç¼©ç•¥å›¾å…ƒç´ 
                const thumbDiv = document.createElement('div');
                thumbDiv.className = index === 0 ? 'thumb active' : 'thumb';
                thumbDiv.dataset.index = index; // å­˜å‚¨ç´¢å¼•æ–¹ä¾¿è°ƒç”¨
                thumbDiv.innerHTML = `<img src="${fullPath}" style="width:100%;height:100%;object-fit:cover;">`;

                // ç‚¹å‡»ç¼©ç•¥å›¾åˆ‡æ¢
                thumbDiv.onclick = function() {
                    changeMainImage(index);
                };
                thumbContainer.appendChild(thumbDiv);
            });

            // åˆå§‹æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾
            changeMainImage(0);

            // ğŸ”¥ 2. å¦‚æœæœ‰å¤šå¼ å›¾ç‰‡ï¼Œæ·»åŠ å·¦å³åˆ‡æ¢ç®­å¤´
            if (globalImageList.length > 1) {
                // æ’å…¥å·¦ç®­å¤´
                const prevBtn = document.createElement('button');
                prevBtn.className = 'nav-arrow arrow-prev';
                prevBtn.innerHTML = '&#10094;'; // å·¦ç®­å¤´å›¾æ ‡ (â®)
                prevBtn.onclick = function() {
                    let newIndex = currentImageIndex - 1;
                    // å¾ªç¯é€»è¾‘ï¼šå¦‚æœæ˜¯ç¬¬ä¸€å¼ ï¼Œç‚¹å·¦ç®­å¤´è·³åˆ°æœ€åä¸€å¼ 
                    if (newIndex < 0) newIndex = globalImageList.length - 1;
                    changeMainImage(newIndex);
                };
                mainImgBox.appendChild(prevBtn);

                // æ’å…¥å³ç®­å¤´
                const nextBtn = document.createElement('button');
                nextBtn.className = 'nav-arrow arrow-next';
                nextBtn.innerHTML = '&#10095;'; // å³ç®­å¤´å›¾æ ‡ (â¯)
                nextBtn.onclick = function() {
                    let newIndex = currentImageIndex + 1;
                    // å¾ªç¯é€»è¾‘ï¼šå¦‚æœæ˜¯æœ€åä¸€å¼ ï¼Œç‚¹å³ç®­å¤´è·³åˆ°ç¬¬ä¸€å¼ 
                    if (newIndex >= globalImageList.length) newIndex = 0;
                    changeMainImage(newIndex);
                };
                mainImgBox.appendChild(nextBtn);
            }

        } else {
            // æ— å›¾å ä½
            mainImgBox.innerText = 'ğŸ“¦';
            thumbContainer.innerHTML = '<div class="thumb active" style="display:flex;align-items:center;justify-content:center;">ğŸ“¦</div>';
        }

        // ğŸ”¥æ–°å¢ï¼šä¿å­˜ä¸¾æŠ¥è¦ç”¨åˆ°çš„ä¿¡æ¯
        currentProductForReport = {
            productId: item.Product_ID,
            sellerUserId: item.User_ID,           // seller's user id (reported user)
            sellerUserName: item.User_Username || ''
        };

        // ğŸ”¥æ–°å¢ï¼šæ›´æ–° Report æŒ‰é’®é“¾æ¥ï¼ˆå¸¦å‚æ•°ï¼‰
        const reportBtn = document.getElementById('reportBtn');
        if (reportBtn) {
            reportBtn.addEventListener('click', function (e) {
                e.preventDefault();
                goToReportPageFromProduct();
            }, { once: true });
        }
    }

    // ğŸ”¥æ–°å¢ï¼šä»å•†å“è¯¦æƒ…é¡µè·³åˆ°ä¸¾æŠ¥é¡µï¼Œå¹¶è‡ªåŠ¨å¸¦ä¸Šå•†å“ID + å¯¹æ–¹ç”¨æˆ·ID/åç§°
    function goToReportPageFromProduct() {
        if (!currentProductForReport || !currentProductForReport.productId) {
            alert('Product info not loaded yet. Please try again.');
            return;
        }

        const url = new URL('../../Module_Platform_Governance_AI_Services/pages/report.html', window.location.href);
        url.searchParams.set('type', 'product');
        url.searchParams.set('itemId', String(currentProductForReport.productId));

        // Report table requires Reported_User_ID NOT NULL, so pass seller id whenever possible
        if (currentProductForReport.sellerUserId) {
            url.searchParams.set('reportedUserId', String(currentProductForReport.sellerUserId));
        }
        if (currentProductForReport.sellerUserName) {
            url.searchParams.set('reportedUserName', currentProductForReport.sellerUserName);
        }

        window.location.href = url.toString();
    }

    // ğŸ”¥ æ–°å¢ï¼šç»Ÿä¸€åˆ‡æ¢ä¸»å›¾çš„å‡½æ•°
    function changeMainImage(index) {
        currentImageIndex = index; // æ›´æ–°å½“å‰ç´¢å¼•

        const mainImgBox = document.getElementById('mainImage');
        const imgRawPath = globalImageList[index];
        const cleanPath = imgRawPath.replace(/^.*?Public_Product_Images\//, 'Public_Product_Images/');
        const fullPath = `../${cleanPath}`;

        // 1. æ›´æ–°ä¸»å›¾ (æ³¨æ„ä¿ç•™ç®­å¤´æŒ‰é’®ï¼Œæ‰€ä»¥è¿™é‡Œä¸èƒ½ç”¨ innerHTML = '')
        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å›¾ç‰‡å…ƒç´ ï¼Œæœ‰åˆ™æ›¿æ¢ srcï¼Œæ²¡æœ‰åˆ™åˆ›å»º
        let mainImgElement = mainImgBox.querySelector('img.main-pic');
        if (!mainImgElement) {
            mainImgElement = document.createElement('img');
            mainImgElement.className = 'main-pic';
            mainImgElement.style.width = '100%';
            mainImgElement.style.height = '100%';
            mainImgElement.style.objectFit = 'contain';
            // æ’å…¥åˆ°æœ€å‰é¢ï¼Œç¡®ä¿åœ¨ç®­å¤´ä¸‹é¢
            mainImgBox.insertBefore(mainImgElement, mainImgBox.firstChild);
        }
        mainImgElement.src = fullPath;


        // 2. æ›´æ–°ç¼©ç•¥å›¾é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.thumb').forEach(t => {
            t.classList.toggle('active', parseInt(t.dataset.index) === index);
        });
    }

    // ğŸ”¥ æ–°å¢ï¼šæ£€æŸ¥æ”¶è—çŠ¶æ€ (ä¿®å¤ç‰ˆ) ğŸ”¥
    async function checkFavoriteStatus() {
        // ä½¿ç”¨å…¨å±€å˜é‡ productId
        if (!productId) return;

        try {
            const response = await fetch('../api/Get_User_Favorites.php');
            const result = await response.json();

            if (result.success && Array.isArray(result.data)) {

                // ğŸ” è°ƒè¯•ä¿¡æ¯ï¼šæŒ‰ F12 çœ‹ Consoleï¼Œå¦‚æœæ²¡å˜çº¢ï¼Œçœ‹çœ‹è¿™é‡Œæ‰“å°äº†ä»€ä¹ˆ
                console.log("å½“å‰å•†å“ID:", productId);
                console.log("æ”¶è—åˆ—è¡¨:", result.data);

                // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæŠŠä¸¤è¾¹éƒ½è½¬æˆ String å†æ¯”è¾ƒï¼Œé˜²æ­¢ç±»å‹ä¸åŒ¹é… (1 vs "1")
                const isFavorited = result.data.some(item => String(item.Product_ID) === String(productId));

                if (isFavorited) {
                    const btn = document.getElementById('favBtn');
                    if (btn) {
                        btn.classList.add('active'); // æ·»åŠ çº¢è‰²æ ·å¼
                        console.log("âœ… å·²åŒ¹é…ï¼Œç‚¹äº®çˆ±å¿ƒ");
                    }
                } else {
                    console.log("âšª æœªåŒ¹é…ï¼Œä¿æŒç°è‰²");
                }
            }
        } catch (error) {
            console.error('æ£€æŸ¥æ”¶è—çŠ¶æ€å‡ºé”™:', error);
        }
    }

    // ğŸ”¥ Fav Logic (å·²æ›¿æ¢ä¸º API äº¤äº’) ğŸ”¥
    async function toggleFav() {
        const btn = document.getElementById('favBtn');

        // è¿™é‡Œçš„ productId æ˜¯ä½ é¡µé¢é¡¶éƒ¨ urlParams è·å–åˆ°çš„å…¨å±€å˜é‡
        if (!productId) return;

        const formData = new FormData();
        formData.append('product_id', productId);

        try {
            const response = await fetch('../api/Toggle_Favorite.php', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                // æ ¹æ®åç«¯è¿”å›çš„åŠ¨ä½œæ›´æ–° UI
                if (result.action === 'added') {
                    btn.classList.add('active');
                    showToast('â¤ï¸ Added to Favorites');
                } else {
                    btn.classList.remove('active');
                    showToast('ğŸ’” Removed from Favorites');
                }
            } else {
                // å¦‚æœå¤±è´¥ï¼ˆä¾‹å¦‚æœªç™»å½•ï¼‰
                if(result.message === 'Please login first') {
                    if(confirm("You need to login to add favorites. Go to login?")) {
                        window.location.href = '../Auth/login.html';
                    }
                } else {
                    showToast('âš ï¸ ' + result.message);
                }
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('âŒ Network Error');
        }
    }

    function showToast(message) {
        var x = document.getElementById("toast");
        x.innerText = message;
        x.className = "toast show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    // ğŸ”¥ æ–°å¢ï¼šè´­ä¹°å‰æ£€æŸ¥ç™»å½•çŠ¶æ€ ğŸ”¥
    async function checkLoginAndProceed(targetUrl) {
        try {
            const response = await fetch('../api/Session_Status.php');
            const result = await response.json();

            if (result.is_logged_in) {
                window.location.href = targetUrl;
            } else {
                // æœªç™»å½•ï¼Œæ˜¾ç¤ºå…¨å±€ç™»å½•å¼¹çª—
                if (typeof AuthModal !== 'undefined') {
                    AuthModal.show();
                } else {
                    // é™çº§å¤„ç†ï¼šå¦‚æœ AuthModal æœªåŠ è½½
                    if(confirm("Please login to continue. Go to login page?")) {
                        window.location.href = '../../Module_User_Account_Management/pages/login.php';
                    }
                }
            }
        } catch (error) {
            console.error('Session check failed:', error);
            // ç½‘ç»œé”™è¯¯ç­‰æƒ…å†µï¼Œå®‰å…¨èµ·è§æç¤ºç”¨æˆ·
            alert("Network error. Please check your connection.");
        }
    }
</script>
<script src="../../Public_Assets/js/auth_modal.js"></script>
</body>
</html>

